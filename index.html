<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" />
  <title>納品書 | 澄和創藝合同会社</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --strong:#111;
      --accent:#0ea5a4;
    }
    *{box-sizing:border-box}
    html, body{width:100%; max-width:100%;}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-text-size-adjust:100%;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px 64px;}
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin:10px 0 16px;
    }

    .brand{display:flex;flex-direction:column;gap:4px;}
    .brand h1{margin:0;font-size:26px;letter-spacing:.5px}
    .brand .sub{color:var(--muted);font-size:13px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    button.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    button:disabled{
      opacity:.6;
      cursor:not-allowed;
    }
    button:active{transform:translateY(1px)}
    .btn-mini{padding:8px 10px;border-radius:12px;font-weight:700;}
    .hint{font-size:12px;color:var(--muted)}

    .grid{
      display:grid;
      grid-template-columns: minmax(340px, 420px) 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 8px 22px rgba(0,0,0,.04);
    }

    .title{
      display:flex;align-items:baseline;justify-content:space-between;gap:12px;flex-wrap:wrap;
      border-bottom:1px solid var(--line);
      padding-bottom:10px;margin-bottom:12px;
    }
    .title h2{margin:0;font-size:18px}
    .small{font-size:12px;color:var(--muted)}

    .row{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:10px;
      align-items:center;
      margin:8px 0;
    }
    .row label{color:var(--muted);font-size:13px}

    /* iOS input zoom対策：16px */
    input, textarea, select{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:16px;
      background:#fff;
      min-width:0;
    }
    textarea{min-height:72px;resize:vertical}

    .dest-box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
    }
    .dest-name{font-weight:800}
    .dest-addr{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.6;white-space:pre-line;}

    .pill{
      display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap;
      padding:10px 12px;
      border:1px dashed var(--line);
      border-radius:14px;
      background:#fafafa;
      margin-top:10px;
    }
    .pill b{color:var(--strong)}

    /* ===== Table (Desktop/Tablet) ===== */
    .table-wrap{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      table-layout:fixed;
      min-width: 860px; /* ✅ 足りないと重なるので安全値 */
    }
    col.no{width:50px}
    col.name{width:auto}
    col.unit{width:140px}
    col.qty{width:90px}
    col.amount{width:160px}
    col.del{width:70px}

    thead th{
      background:#f3f4f6;
      color:#111;
      font-weight:700;
      font-size:13px;
      padding:10px 10px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:8px 8px;
      vertical-align:middle;
      font-size:14px;
      overflow:hidden;
    }
    tbody tr:last-child td{border-bottom:none}

    .num{ text-align:right; font-variant-numeric: tabular-nums; }
    .center{text-align:center}

    /* ✅ 作品名“不要夸张超长”：桌面端就吃满本列即可 */
    td.namecell input.name{
      width:100%;
      min-width:0;
    }
    td.unitcell input, td.qtycell input{width:100%; text-align:right;}

    .table-actions{margin-top:10px;display:flex;justify-content:center;}
    .table-actions button{padding:12px 16px;border-radius:14px;font-weight:800;}

    .sum{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){ .sum{grid-template-columns:1fr} }

    .sum-box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .sum-row{
      display:flex;justify-content:space-between;gap:12px;
      padding:8px 0;border-bottom:1px solid var(--line);
      font-variant-numeric: tabular-nums;
    }
    .sum-row:last-child{border-bottom:none}
    .sum-row .k{color:#111;font-weight:700}
    .sum-row .v{font-weight:800}

    .footer-note{margin-top:12px;color:var(--muted);font-size:12px;line-height:1.7;}

    /* ===== Mobile cards ===== */
    @media (max-width: 600px){
      table{min-width:0;}
      .table-wrap{overflow:visible;border:0;background:transparent;}
      table, thead, tbody, tr, td{display:block;width:100%;}
      thead{display:none;}
      table{background:transparent;}

      tbody tr{
        background:#fff;
        border:1px solid var(--line);
        border-radius:16px;
        padding:12px;
        margin:10px 0;
        box-shadow: 0 8px 22px rgba(0,0,0,.04);
      }
      tbody td{border-bottom:0;padding:8px 0;overflow:visible;}

      tbody td:nth-child(1){
        padding-top:0;
        font-weight:800;
        color:#111;
        display:flex;
        justify-content:center;
      }
      tbody td:nth-child(1)::before{content:none;}

      /* ✅ 手机端：品名改成“上下结构”，避免你截图那种横向超长 */
      tbody td:nth-child(2){
        display:block;
      }
      tbody td:nth-child(2)::before{
        content:"品名 / 作品名";
        display:block;
        color:var(--muted);
        font-weight:700;
        font-size:12px;
        margin-bottom:6px;
      }
      tbody td:nth-child(2) input{width:100%;}

      /* 单价/数量保持左右结构 */
      tbody td:nth-child(3),
      tbody td:nth-child(4),
      tbody td:nth-child(5),
      tbody td:nth-child(6){
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
      }
      tbody td:nth-child(3)::before{content:"単価";color:var(--muted);font-weight:700;font-size:12px;flex:0 0 auto;}
      tbody td:nth-child(4)::before{content:"数量";color:var(--muted);font-weight:700;font-size:12px;flex:0 0 auto;}
      tbody td:nth-child(5)::before{content:"金額";color:var(--muted);font-weight:700;font-size:12px;flex:0 0 auto;}
      tbody td:nth-child(6)::before{content:"削除";color:var(--muted);font-weight:700;font-size:12px;flex:0 0 auto;}

      tbody td:nth-child(3) input,
      tbody td:nth-child(4) input{width:58%; text-align:right;}

      tbody td:nth-child(5){
        padding-top:10px;
        border-top:1px dashed var(--line);
        margin-top:6px;
      }
      .amount{font-weight:900}
      tbody td:nth-child(6) button{padding:10px 14px;border-radius:14px;font-weight:900;}

      .sum{grid-template-columns:1fr;}
    }

    /* ===== Print (系统打印) ===== */
    @page { size: A4; margin: 12mm; }
    @media print{
      body{background:#fff}
      .wrap{max-width:none;padding:0}
      .actions, .pill, .table-actions{display:none !important}
      .card{box-shadow:none;border:0;border-radius:0;padding:0}
      .grid{grid-template-columns:1fr !important;gap:0 !important}
      .table-wrap{border:1px solid #999;border-radius:0; overflow:visible !important; background:#fff !important;}

      table{display:table !important; width:100% !important; border-collapse:collapse !important; table-layout:fixed !important; min-width:0 !important;}
      thead{display:table-header-group !important;}
      tbody{display:table-row-group !important;}
      tr{display:table-row !important; page-break-inside:avoid !important;}
      th, td{display:table-cell !important;}
      td::before{content:none !important;}
      tbody tr{box-shadow:none !important;border:0 !important;border-radius:0 !important;padding:0 !important;margin:0 !important;}
      thead th{background:#eee !important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
      tbody td{border:1px solid #999 !important;padding:8px 8px !important;overflow:hidden !important;}
      input, textarea, select{border:0 !important;padding:0 !important;font-size:12px !important;background:transparent !important;}
    }

    .brandline{display:flex;align-items:center;gap:14px;}
    .logo{height:48px;width:auto;display:block;}

    /* PDF 生成时使用：隐藏不需要的 UI */
    .pdf-only-hide{display:block;}
  </style>

  <!-- ✅ PDF 生成库（安卓更稳）：html2pdf.js 依赖 html2canvas + jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="brandline">
          <img src="cleon-logo.PNG" alt="Cléon arts & trade" class="logo" />
          <div>
            <h1>納品書</h1>
            <div class="sub"><b>澄和創藝合同会社</b>　｜　PDFは右のボタンから作成できます。</div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-mini" id="clearBtn">入力をリセット</button>

        <!-- ✅ 新：PDFファイルとしてダウンロード（安卓也可） -->
        <button type="button" class="primary btn-mini" id="pdfBtn">PDFをダウンロード</button>

        <!-- 可选：保留系统打印（桌面更方便） -->
        <button type="button" class="btn-mini" id="printBtn" title="PCで印刷したい場合">印刷</button>
        <span class="hint" id="pdfHint"></span>
      </div>
    </div>

    <!-- ✅ 用于生成PDF的容器：我们会克隆这份内容并强制“表格模式” -->
    <div id="pdfRoot">
      <div class="grid">
        <!-- LEFT -->
        <div class="card">
          <div class="title">
            <h2>基本情報</h2>
            <div class="small">作者さまが入力 → PDF保存 → メール/LINE等で送付</div>
          </div>

          <div class="row">
            <label>宛先</label>
            <div class="dest-box">
              <div class="dest-name">澄和創藝合同会社</div>
              <div class="dest-addr">〒185-0032
東京都国分寺市日吉町2-34-14 2G号室</div>
            </div>
          </div>

          <div class="row">
            <label>納品書番号（任意）</label>
            <input id="docNo" placeholder="例：2026-001" data-ph="例：2026-001" />
          </div>

          <div class="row">
            <label>納品日</label>
            <input id="docDate" type="date" />
          </div>

          <div class="row">
            <label>姓名</label>
            <input id="authorName" placeholder="例：澄和 花子" data-ph="例：澄和 花子" />
          </div>

          <div class="row">
            <label>屋号</label>
            <input id="shopName" placeholder="例：atelier ○○" data-ph="例：atelier ○○" />
          </div>

          <div class="row">
            <label>TEL</label>
            <input id="tel" placeholder="例：090-xxxx-xxxx" data-ph="例：090-xxxx-xxxx" />
          </div>

          <div class="row">
            <label>住所（任意）</label>
            <textarea id="addr" placeholder="例：〒xxx-xxxx 東京都…" data-ph="例：〒xxx-xxxx 東京都…"></textarea>
          </div>

          <div class="pill">
            <span>入力方式：</span>
            <select id="mode">
              <option value="taxin" selected>おすすめ：税込（消費税10%込）で入力</option>
              <option value="taxex">税抜（消費税を別計算）で入力</option>
            </select>
            <span class="small">税率：<b>10%</b>（固定）｜端数処理：<b>四捨五入（1円未満）</b></span>
          </div>

          <div class="footer-note">
            <span class="screenonly">※「税込（10%込）」を選ぶと、作者さまは<b>税込単価</b>だけ入力すればOKです（税額は自動で内訳表示）。</span><br/>
            当サイトはCléon専用の内部ツールであり、入力情報は厳重に管理され、外部への流出は一切ありません。
          </div>
        </div>

        <!-- RIGHT -->
        <div class="card">
          <div class="title">
            <h2>明細</h2>
            <div class="small">単価 × 数量 → 金額（自動）</div>
          </div>

          <div class="table-wrap">
            <table id="itemsTable">
              <colgroup>
                <col class="no">
                <col class="name">
                <col class="unit">
                <col class="qty">
                <col class="amount">
                <col class="del">
              </colgroup>
              <thead>
                <tr>
                  <th class="center">No</th>
                  <th>品名 / 作品名</th>
                  <th class="num">単価</th>
                  <th class="num">数量</th>
                  <th class="num">金額</th>
                  <th class="center">削除</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="table-actions pdf-only-hide">
            <button type="button" class="btn-mini" id="addRowBtn">＋ 行を追加</button>
          </div>

          <div class="sum">
            <div class="footer-note">
              ※ 金額は自動計算です。PDF化する場合は「PDFをダウンロード」を押してください。<br/>
              ※ 税込入力時：<b>合計（税込）</b>は入力金額の合算、その内訳として<b>小計（税抜）</b>と<b>消費税</b>を算出します。
            </div>

            <div class="sum-box">
              <div class="sum-row">
                <div class="k">小計</div>
                <div class="v" id="subTotal">0 円</div>
              </div>
              <div class="sum-row">
                <div class="k">消費税（10%）</div>
                <div class="v" id="tax">0 円</div>
              </div>
              <div class="sum-row">
                <div class="k">合計</div>
                <div class="v" id="grandTotal">0 円</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div><!-- /pdfRoot -->
  </div>

<script>
  // ===== helpers =====
  const yen = (n)=> (Number.isFinite(n) ? n : 0).toLocaleString("ja-JP") + " 円";
  const toInt = (v)=> {
    if (v === null || v === undefined) return 0;
    const s = String(v).replace(/[^\d.-]/g,'');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const roundYen = (n)=> Math.round(n);

  // ===== placeholder control =====
  const _phBackup = new Map();
  function clearPlaceholders(){
    document.querySelectorAll("[data-ph], .name, .unit, .qty").forEach(el=>{
      _phBackup.set(el, el.getAttribute("placeholder") || "");
      el.setAttribute("placeholder", "");
    });
  }
  function restorePlaceholders(){
    _phBackup.forEach((val, el)=>{
      try{ el.setAttribute("placeholder", val); }catch(e){}
    });
    _phBackup.clear();
  }

  // ===== state =====
  const tbody = document.getElementById("tbody");
  const addRowBtn = document.getElementById("addRowBtn");
  const clearBtn = document.getElementById("clearBtn");
  const printBtn = document.getElementById("printBtn");
  const pdfBtn = document.getElementById("pdfBtn");
  const pdfHint = document.getElementById("pdfHint");
  const modeSel = document.getElementById("mode");

  const subTotalEl = document.getElementById("subTotal");
  const taxEl = document.getElementById("tax");
  const grandTotalEl = document.getElementById("grandTotal");

  function makeRow(i){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center no">${i}</td>
      <td class="namecell"><input class="name" placeholder="例：カップショートケーキ / ブローチ など" /></td>
      <td class="num unitcell"><input class="unit" inputmode="numeric" placeholder="0" /></td>
      <td class="num qtycell"><input class="qty" inputmode="numeric" placeholder="1" value="1" /></td>
      <td class="num amount">0 円</td>
      <td class="center"><button type="button" class="btn-mini del">×</button></td>
    `;
    tr.querySelector(".del").addEventListener("click", ()=>{
      tr.remove();
      renumber();
      recalc();
    });
    tr.querySelectorAll("input").forEach(inp=>{
      inp.addEventListener("input", recalc);
    });
    return tr;
  }

  function renumber(){
    [...tbody.querySelectorAll("tr")].forEach((tr, idx)=>{
      tr.querySelector(".no").textContent = String(idx+1);
    });
  }

  function addRows(n){
    const start = tbody.querySelectorAll("tr").length;
    for(let k=0;k<n;k++){
      tbody.appendChild(makeRow(start + k + 1));
    }
    recalc();
  }

  function recalc(){
    let sumLine = 0;
    [...tbody.querySelectorAll("tr")].forEach(tr=>{
      const unit = toInt(tr.querySelector(".unit").value);
      const qty  = Math.max(0, toInt(tr.querySelector(".qty").value || 0));
      const amt  = roundYen(unit * qty);
      tr.querySelector(".amount").textContent = yen(amt);
      sumLine += amt;
    });

    const mode = modeSel.value;
    const taxRate = 0.10;

    if(mode === "taxex"){
      const sub = roundYen(sumLine);
      const tax = roundYen(sub * taxRate);
      const total = sub + tax;
      subTotalEl.textContent = yen(sub);
      taxEl.textContent = yen(tax);
      grandTotalEl.textContent = yen(total);
    }else{
      const total = roundYen(sumLine);
      const sub = roundYen(total / (1 + taxRate));
      const tax = total - sub;
      subTotalEl.textContent = yen(sub);
      taxEl.textContent = yen(tax);
      grandTotalEl.textContent = yen(total);
    }
  }

  addRowBtn.addEventListener("click", ()=> addRows(1));

  clearBtn.addEventListener("click", ()=>{
    if(!confirm("入力内容をリセットします。よろしいですか？")) return;
    document.getElementById("docNo").value = "";
    document.getElementById("docDate").value = "";
    document.getElementById("authorName").value = "";
    document.getElementById("shopName").value = "";
    document.getElementById("tel").value = "";
    document.getElementById("addr").value = "";
    modeSel.value = "taxin";
    tbody.innerHTML = "";
    addRows(6);
  });

  modeSel.addEventListener("change", recalc);

  // ===== System print (PC向け) =====
  printBtn.addEventListener("click", ()=>{
    clearPlaceholders();
    window.print();
    setTimeout(restorePlaceholders, 1200);
  });

  // ===== ✅ PDF download (安卓/iOS/PC) =====
  async function downloadPDF(){
    if(!window.html2pdf){
      alert("PDF生成ライブラリの読み込みに失敗しました。通信環境をご確認ください。");
      return;
    }

    pdfBtn.disabled = true;
    pdfHint.textContent = "PDFを作成中…";

    // 1) 先に placeholder 消す（PDFに例文を出さない）
    clearPlaceholders();

    // 2) PDF用にDOMをクローンして、必ず“表形式”に固定
    const src = document.getElementById("pdfRoot");
    const clone = src.cloneNode(true);

    // クローン側は「行を追加」ボタン等を消す
    clone.querySelectorAll(".pdf-only-hide").forEach(el=> el.style.display = "none");

    // クローンを一時的に画面外に設置（レンダリング用）
    const host = document.createElement("div");
    host.style.position = "fixed";
    host.style.left = "-99999px";
    host.style.top = "0";
    host.style.width = "1100px"; // ✅ 安定：A4レイアウトに近い幅
    host.appendChild(clone);
    document.body.appendChild(host);

    // 3) html2pdf 設定：A4固定、余白、画質
    const fileName = (() => {
      const docNo = (document.getElementById("docNo").value || "").trim();
      const author = (document.getElementById("authorName").value || "").trim();
      const d = (document.getElementById("docDate").value || "").trim();
      const base = docNo ? `納品書_${docNo}` : "納品書";
      const tail = [author, d].filter(Boolean).join("_");
      return (tail ? `${base}_${tail}` : base) + ".pdf";
    })();

    try{
      await html2pdf()
        .set({
          margin: [12, 12, 12, 12], // mm
          filename: fileName,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: {
            scale: 2,           // ✅ 清晰
            useCORS: true,
            backgroundColor: "#ffffff",
            scrollY: 0
          },
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
          pagebreak: { mode: ["css", "legacy"] }
        })
        .from(clone)
        .save();
    }catch(e){
      alert("PDFの作成に失敗しました。別のブラウザ（Chrome/Edge）でお試しください。");
    }finally{
      // cleanup
      document.body.removeChild(host);
      restorePlaceholders();
      pdfBtn.disabled = false;
      pdfHint.textContent = "";
    }
  }

  pdfBtn.addEventListener("click", downloadPDF);

  // init date
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  document.getElementById("docDate").value = `${yyyy}-${mm}-${dd}`;

  addRows(6);
</script>
</body>
</html>
