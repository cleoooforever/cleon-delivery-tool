<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" />
  <title>ç´å“æ›¸ | æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#0ea5a4;
      --shadow:0 8px 22px rgba(0,0,0,.04);
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ width:100%; max-width:100%; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Roboto,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-text-size-adjust:100%;
    }

    /* Layout */
    .wrap{ max-width:1100px; margin:0 auto; padding:18px 16px 64px; }
    .topbar{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin:10px 0 16px;
    }
    .brand{ display:flex; flex-direction:column; gap:4px; }
    .brandline{ display:flex; align-items:center; gap:14px; }
    .logo{ height:48px; width:auto; display:block; }
    .brand h1{ margin:0; font-size:26px; letter-spacing:.5px; }
    .sub{ color:var(--muted); font-size:13px; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    button{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      -webkit-tap-highlight-color:transparent;
    }
    button.primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    button:active:not(:disabled){ transform:translateY(1px); }
    .btn-mini{ padding:8px 12px; border-radius:12px; font-weight:800; }
    .hint{ font-size:12px; color:var(--muted); }

    .grid{
      display:grid;
      grid-template-columns:minmax(320px, 400px) 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width:900px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .sec-title{
      display:flex; align-items:baseline; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      border-bottom:1px solid var(--line);
      padding-bottom:10px; margin-bottom:12px;
    }
    .sec-title h2{ margin:0; font-size:18px; }
    .small{ font-size:12px; color:var(--muted); }

    /* åŸºæœ¬æƒ…å ± rows (desktop default) */
    .row{
      display:grid;
      grid-template-columns:150px 1fr;
      gap:8px;
      align-items:center;
      margin:8px 0;
    }
    .row label{ color:var(--muted); font-size:13px; }

    /* Inputs */
    input,textarea,select{
      width:100%;
      min-width:0;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:16px; /* iOS zoomé˜²æ­¢ */
      background:#fff;
      color:var(--text);
      font-family:inherit;
    }
    textarea{ min-height:72px; resize:vertical; }

    /* âœ… iOS Safari date input width / appearance normalization */
    input[type="date"]{
      max-width:100%;
      width:100%;
      min-width:0;
      -webkit-appearance:none;
      appearance:none;
    }

    .dest-box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
    }
    .dest-name{ font-weight:900; }
    .dest-addr{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
      white-space:pre-line;
    }

    .pill{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:10px 12px;
      border:1px dashed var(--line);
      border-radius:14px;
      background:#fafafa;
      margin-top:10px;
    }
    .footer-note{ margin-top:12px; color:var(--muted); font-size:12px; line-height:1.7; }

    /* ===========================================================
       âœ… Desktop Table (always default)
       é‡ç‚¹ï¼šå“ååˆ—åƒæ‰å‰©ä½™å®½åº¦ï¼Œå…¶ä»–åˆ—å›ºå®šå®½åº¦ â†’ ç¨³å®šä¸”ä¸æŒ¤
       =========================================================== */
    .table-wrap{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      table-layout:fixed;
    }

    /* âœ… æ›´â€œç¨³â€çš„åˆ—å®½ï¼ˆä½ è¦çš„å“åå¾ˆé•¿ï¼‰ */
    col.no     { width:56px; }
    col.unit   { width:120px; }
    col.qty    { width:90px; }
    col.amount { width:130px; }
    col.del    { width:66px; }
    col.name   { width:auto; } /* åƒå‰©ä½™ */

    thead th{
      background:#f3f4f6;
      color:#111;
      font-weight:800;
      font-size:13px;
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:8px 8px;
      vertical-align:middle;
      font-size:14px;
      overflow:hidden;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .num{ text-align:right; font-variant-numeric:tabular-nums; }
    .center{ text-align:center; }

    /* âœ… å…³é”®ï¼štd å†… input å¿…é¡» min-width:0ï¼Œå¦åˆ™ Safari/Chromium å¯èƒ½æŒ¤çˆ†/é‡å  */
    td input{
      width:100%;
      min-width:0;
      padding:7px 10px;
      font-size:14px;
      border-radius:10px;
    }
    td.unitcell input, td.qtycell input{ text-align:right; }

    .table-actions{ margin-top:10px; display:flex; justify-content:center; }
    .table-actions button{ padding:12px 18px; border-radius:14px; font-weight:900; }

    .sum{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 300px;
      gap:12px;
      align-items:start;
    }
    @media (max-width:900px){ .sum{ grid-template-columns:1fr; } }
    .sum-box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .sum-row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:8px 0;
      border-bottom:1px solid var(--line);
      font-variant-numeric:tabular-nums;
    }
    .sum-row:last-child{ border-bottom:none; }
    .sum-row .k{ color:#111; font-weight:800; }
    .sum-row .v{ font-weight:900; }

    /* ===========================================================
       âœ… Mobile card layout (JSã§ body.is-mobile ã‚’ä»˜ä¸ã—ãŸæ™‚ã ã‘)
       =========================================================== */
    body.is-mobile .row{
      grid-template-columns:1fr;
      gap:4px;
      align-items:stretch;
      margin:10px 0;
    }
    body.is-mobile .row label{
      font-size:12px;
      font-weight:700;
      color:var(--muted);
    }

    body.is-mobile .table-wrap{ overflow:visible; border:0; background:transparent; }
    body.is-mobile table{ min-width:0; background:transparent; }
    body.is-mobile table,
    body.is-mobile thead,
    body.is-mobile tbody,
    body.is-mobile tr,
    body.is-mobile td{ display:block; width:100%; }
    body.is-mobile thead{ display:none; }

    body.is-mobile tbody tr{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin:10px 0;
      box-shadow:var(--shadow);
    }
    body.is-mobile tbody td{ border-bottom:0; padding:6px 0; overflow:visible; }

    body.is-mobile tbody td:nth-child(1){
      padding-top:0;
      font-weight:900;
      color:#111;
      display:flex;
      justify-content:center;
    }
    body.is-mobile tbody td:nth-child(2)::before{
      content:"å“å / ä½œå“å";
      display:block;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      margin-bottom:6px;
    }
    body.is-mobile tbody td:nth-child(3),
    body.is-mobile tbody td:nth-child(4),
    body.is-mobile tbody td:nth-child(5),
    body.is-mobile tbody td:nth-child(6){
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    body.is-mobile tbody td:nth-child(3)::before{ content:"å˜ä¾¡"; color:var(--muted); font-weight:800; font-size:12px; }
    body.is-mobile tbody td:nth-child(4)::before{ content:"æ•°é‡"; color:var(--muted); font-weight:800; font-size:12px; }
    body.is-mobile tbody td:nth-child(5)::before{ content:"é‡‘é¡"; color:var(--muted); font-weight:800; font-size:12px; }
    body.is-mobile tbody td:nth-child(6)::before{ content:"å‰Šé™¤"; color:var(--muted); font-weight:800; font-size:12px; }

    body.is-mobile tbody td:nth-child(3) input,
    body.is-mobile tbody td:nth-child(4) input{ width:60%; text-align:right; }

    body.is-mobile tbody td:nth-child(5){
      padding-top:10px;
      border-top:1px dashed var(--line);
      margin-top:6px;
    }
    body.is-mobile .amount{ font-weight:950; }

    body.is-mobile tbody td:nth-child(6) button{
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
    }

    /* âœ… iPhone Safari: date input åœ¨ mobile ä¸‹æœ‰æ—¶ä¼šâ€œæ˜¾å¾—æ›´é•¿â€ï¼Œè¿™é‡Œå¼ºåˆ¶ä¸€è‡´ */
    body.is-mobile input[type="date"]{
      width:100%;
      max-width:100%;
      display:block;
    }

    /* ===========================================================
       Print (A4)
       =========================================================== */
    @page { size:A4; margin:12mm; }
    @media print{
      body{ background:#fff; }
      .wrap{ max-width:none; padding:0; }
      .actions, .pill, .table-actions, .footer-note { display:none !important; }
      .card{ box-shadow:none; border:0; border-radius:0; padding:0; }
      .grid{ display:block !important; }
      .topbar{ margin-bottom:14px; }

      .table-wrap{
        border:1px solid #aaa;
        border-radius:0;
        overflow:visible !important;
        background:#fff !important;
      }
      table{
        display:table !important;
        width:100% !important;
        border-collapse:collapse !important;
        table-layout:fixed !important;
        min-width:0 !important;
      }
      col.no     { width:38px !important; }
      col.unit   { width:100px !important; }
      col.qty    { width:65px !important; }
      col.amount { width:115px !important; }
      col.del    { width:0 !important; display:none !important; }

      thead{ display:table-header-group !important; }
      tbody{ display:table-row-group !important; }
      tr{ display:table-row !important; page-break-inside:avoid !important; }
      th,td{ display:table-cell !important; }
      td::before{ content:none !important; }
      tbody tr{
        box-shadow:none !important;
        border:0 !important;
        border-radius:0 !important;
        padding:0 !important;
        margin:0 !important;
        background:#fff !important;
      }
      thead th{
        background:#efefef !important;
        -webkit-print-color-adjust:exact;
        print-color-adjust:exact;
      }
      tbody td{
        border:1px solid #aaa !important;
        padding:6px 8px !important;
        overflow:hidden !important;
        vertical-align:middle !important;
        font-size:12px !important;
      }
      th:last-child, td:last-child{ display:none !important; }

      input,textarea,select{
        border:0 !important;
        padding:0 !important;
        font-size:12px !important;
        background:transparent !important;
        -webkit-appearance:none;
        appearance:none;
        box-shadow:none !important;
      }

      .row{
        grid-template-columns:140px 1fr !important;
        gap:6px !important;
        align-items:center !important;
        margin:5px 0 !important;
      }
      .sum{ grid-template-columns:1fr !important; }
      .sum-box{ width:260px; margin-left:auto; }
    }
  </style>

  <!-- libs: html2pdf (desktop & supported mobile) -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="brandline">
        <img src="cleon-logo.PNG" alt="ClÃ©on arts &amp; trade" class="logo" />
        <div>
          <h1>ç´å“æ›¸</h1>
          <div class="sub"><b>æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</b>ã€€ï½œã€€PDFã¯å³ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã§ãã¾ã™ã€‚</div>
        </div>
      </div>
    </div>
    <div class="actions">
      <button type="button" class="btn-mini" id="clearBtn">å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button type="button" class="primary btn-mini" id="pdfBtn">ğŸ“„ PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button type="button" class="btn-mini" id="printBtn">ğŸ–¨ å°åˆ·</button>
      <span class="hint" id="pdfHint"></span>
    </div>
  </div>

  <div id="screenRoot">
    <div class="grid">

      <!-- LEFT -->
      <div class="card">
        <div class="sec-title">
          <h2>åŸºæœ¬æƒ…å ±</h2>
          <div class="small">ä½œè€…ã•ã¾ãŒå…¥åŠ› â†’ PDFä¿å­˜ â†’ ãƒ¡ãƒ¼ãƒ«/LINEç­‰ã§é€ä»˜</div>
        </div>

        <div class="row">
          <label>å®›å…ˆ</label>
          <div class="dest-box">
            <div class="dest-name">æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</div>
            <div class="dest-addr">ã€’185-0032 æ±äº¬éƒ½å›½åˆ†å¯ºå¸‚æ—¥å‰ç”º2-34-14 2Gå·å®¤</div>
          </div>
        </div>

        <div class="row">
          <label>ç´å“æ›¸ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
          <input id="docNo" placeholder="ä¾‹ï¼š2026-001" data-ph="ä¾‹ï¼š2026-001" />
        </div>

        <div class="row">
          <label>ç´å“æ—¥</label>
          <input id="docDate" type="date" />
        </div>

        <div class="row">
          <label>å§“å</label>
          <input id="authorName" placeholder="ä¾‹ï¼šæ¾„å’Œ èŠ±å­" data-ph="ä¾‹ï¼šæ¾„å’Œ èŠ±å­" />
        </div>

        <div class="row">
          <label>å±‹å·</label>
          <input id="shopName" placeholder="ä¾‹ï¼šatelier â—‹â—‹" data-ph="ä¾‹ï¼šatelier â—‹â—‹" />
        </div>

        <div class="row">
          <label>TEL</label>
          <input id="tel" placeholder="ä¾‹ï¼š090-xxxx-xxxx" data-ph="ä¾‹ï¼š090-xxxx-xxxx" />
        </div>

        <div class="row">
          <label>ä½æ‰€ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="addr" placeholder="ä¾‹ï¼šã€’xxx-xxxx æ±äº¬éƒ½â€¦" data-ph="ä¾‹ï¼šã€’xxx-xxxx æ±äº¬éƒ½â€¦"></textarea>
        </div>

        <div class="pill">
          <span>å…¥åŠ›æ–¹å¼ï¼š</span>
          <select id="mode">
            <option value="taxin" selected>ãŠã™ã™ã‚ï¼šç¨è¾¼ï¼ˆæ¶ˆè²»ç¨10%è¾¼ï¼‰ã§å…¥åŠ›</option>
            <option value="taxex">ç¨æŠœï¼ˆæ¶ˆè²»ç¨ã‚’åˆ¥è¨ˆç®—ï¼‰ã§å…¥åŠ›</option>
          </select>
          <span class="small">ç¨ç‡ï¼š<b>10%</b>ï½œç«¯æ•°ï¼š<b>å››æ¨äº”å…¥</b></span>
        </div>

        <div class="footer-note">
          â€»ã€Œç¨è¾¼ï¼ˆ10%è¾¼ï¼‰ã€ã‚’é¸ã¶ã¨ã€ä½œè€…ã•ã¾ã¯<b>ç¨è¾¼å˜ä¾¡</b>ã ã‘å…¥åŠ›ã™ã‚Œã°OKã§ã™ã€‚<br/>
          å½“ã‚µã‚¤ãƒˆã¯ClÃ©onå°‚ç”¨ã®å†…éƒ¨ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å…¥åŠ›æƒ…å ±ã¯å¤–éƒ¨ã¸æµå‡ºã—ã¾ã›ã‚“ã€‚
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="sec-title">
          <h2>æ˜ç´°</h2>
          <div class="small">å˜ä¾¡ Ã— æ•°é‡ â†’ é‡‘é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</div>
        </div>

        <div class="table-wrap">
          <table id="itemsTable">
            <colgroup>
              <col class="no">
              <col class="name">
              <col class="unit">
              <col class="qty">
              <col class="amount">
              <col class="del">
            </colgroup>
            <thead>
              <tr>
                <th class="center">No</th>
                <th>å“å / ä½œå“å</th>
                <th class="num">å˜ä¾¡</th>
                <th class="num">æ•°é‡</th>
                <th class="num">é‡‘é¡</th>
                <th class="center">å‰Šé™¤</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="table-actions">
          <button type="button" class="btn-mini" id="addRowBtn">ï¼‹ è¡Œã‚’è¿½åŠ </button>
        </div>

        <div class="sum">
          <div class="footer-note">
            â€» é‡‘é¡ã¯è‡ªå‹•è¨ˆç®—ã§ã™ã€‚ã€ŒPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§PDFãŒä½œæˆã§ãã¾ã™ã€‚<br/>
            â€» ç¨è¾¼å…¥åŠ›æ™‚ï¼šåˆè¨ˆï¼ˆç¨è¾¼ï¼‰ã¯å…¥åŠ›é‡‘é¡ã®åˆç®—ã€å†…è¨³ã¨ã—ã¦å°è¨ˆï¼ˆç¨æŠœï¼‰ã¨æ¶ˆè²»ç¨ã‚’ç®—å‡ºã—ã¾ã™ã€‚
          </div>

          <div class="sum-box">
            <div class="sum-row"><div class="k">å°è¨ˆ</div><div class="v" id="subTotal">0 å††</div></div>
            <div class="sum-row"><div class="k">æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰</div><div class="v" id="tax">0 å††</div></div>
            <div class="sum-row"><div class="k">åˆè¨ˆ</div><div class="v" id="grandTotal">0 å††</div></div>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<script>
/* ===========================================================
  Helpers
=========================================================== */
const yen = n => (Number.isFinite(n) ? n : 0).toLocaleString("ja-JP") + " å††";
const toInt = v => {
  const n = Number(String(v ?? "").replace(/[^\d.-]/g, ""));
  return Number.isFinite(n) ? n : 0;
};
const roundY = n => Math.round(n);

/* placeholders remove for print/pdf */
const _phBackup = new Map();
function clearPH(){
  document.querySelectorAll("[data-ph], input.name, input.unit, input.qty").forEach(el=>{
    _phBackup.set(el, el.getAttribute("placeholder") || "");
    el.setAttribute("placeholder","");
  });
}
function restorePH(){
  _phBackup.forEach((v,el)=>{ try{ el.setAttribute("placeholder", v); }catch(e){} });
  _phBackup.clear();
}

/* ===========================================================
  âœ… Mobile detection: JS-based (avoid Safari media quirks)
=========================================================== */
function checkMobile(){
  if (window.innerWidth <= 620) document.body.classList.add("is-mobile");
  else document.body.classList.remove("is-mobile");
}
checkMobile();
window.addEventListener("resize", checkMobile);

/* ===========================================================
  DOM refs
=========================================================== */
const tbody = document.getElementById("tbody");
const modeSel = document.getElementById("mode");
const subTotalEl = document.getElementById("subTotal");
const taxEl = document.getElementById("tax");
const grandTotalEl = document.getElementById("grandTotal");

/* ===========================================================
  Table rows
=========================================================== */
function makeRow(i){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="center no">${i}</td>
    <td class="namecell"><input class="name" placeholder="ä¾‹ï¼šã‚«ãƒƒãƒ—ã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­ / ãƒ–ãƒ­ãƒ¼ãƒ ãªã©" /></td>
    <td class="num unitcell"><input class="unit" inputmode="numeric" placeholder="0" /></td>
    <td class="num qtycell"><input class="qty" inputmode="numeric" placeholder="1" value="1" /></td>
    <td class="num amount">0 å††</td>
    <td class="center"><button type="button" class="btn-mini del">Ã—</button></td>
  `;
  tr.querySelector(".del").addEventListener("click", ()=>{ tr.remove(); renumber(); recalc(); });
  tr.querySelectorAll("input").forEach(inp=> inp.addEventListener("input", recalc));
  return tr;
}
function renumber(){
  [...tbody.querySelectorAll("tr")].forEach((tr,i)=>{ tr.querySelector(".no").textContent = i+1; });
}
function addRows(n){
  const start = tbody.querySelectorAll("tr").length;
  for (let k=0;k<n;k++) tbody.appendChild(makeRow(start+k+1));
  recalc();
}
function recalc(){
  let sum = 0;
  [...tbody.querySelectorAll("tr")].forEach(tr=>{
    const unit = toInt(tr.querySelector(".unit").value);
    const qty = Math.max(0, toInt(tr.querySelector(".qty").value || 0));
    const amt = roundY(unit * qty);
    tr.querySelector(".amount").textContent = yen(amt);
    sum += amt;
  });
  const rate = 0.10;
  const mode = modeSel.value;
  if (mode === "taxex"){
    const sub = roundY(sum);
    const tax = roundY(sub * rate);
    subTotalEl.textContent = yen(sub);
    taxEl.textContent = yen(tax);
    grandTotalEl.textContent = yen(sub + tax);
  }else{
    const total = roundY(sum);
    const sub = roundY(total / (1 + rate));
    const tax = total - sub;
    subTotalEl.textContent = yen(sub);
    taxEl.textContent = yen(tax);
    grandTotalEl.textContent = yen(total);
  }
}
document.getElementById("addRowBtn").addEventListener("click", ()=> addRows(1));
modeSel.addEventListener("change", recalc);

/* ===========================================================
  Reset
=========================================================== */
document.getElementById("clearBtn").addEventListener("click", ()=>{
  if (!confirm("å…¥åŠ›å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  ["docNo","authorName","shopName","tel","addr"].forEach(id=> document.getElementById(id).value = "");
  const d = new Date();
  document.getElementById("docDate").value =
    `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  modeSel.value = "taxin";
  tbody.innerHTML = "";
  addRows(6);
});

/* ===========================================================
  Print
=========================================================== */
document.getElementById("printBtn").addEventListener("click", ()=>{
  clearPH();
  window.print();
  setTimeout(restorePH, 1200);
});

/* ===========================================================
  Filename
=========================================================== */
function makeName(){
  const no = (document.getElementById("docNo").value || "").trim();
  const au = (document.getElementById("authorName").value || "").trim();
  const dt = (document.getElementById("docDate").value || "").trim();
  const base = no ? `ç´å“æ›¸_${no}` : "ç´å“æ›¸";
  const tail = [au, dt].filter(Boolean).join("_");
  return (tail ? `${base}_${tail}` : base) + ".pdf";
}

/* ===========================================================
  Build A4 "print-like" DOM (ONE source of truth)
  é‡ç‚¹ï¼šPDF / Mobile Preview / Desktop Download å…¨éƒ¨ç”¨åŒä¸€å¼  A4 è¡¨æ ¼æ’ç‰ˆ
=========================================================== */
function esc(s){
  return String(s || "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/\n/g,"<br/>");
}

function buildA4HTML(){
  const docNo = document.getElementById("docNo").value;
  const docDate = document.getElementById("docDate").value;
  const author = document.getElementById("authorName").value;
  const shop = document.getElementById("shopName").value;
  const tel = document.getElementById("tel").value;
  const addr = document.getElementById("addr").value;

  const rows = [...tbody.querySelectorAll("tr")].map(tr=>({
    no: tr.querySelector(".no").textContent,
    name: tr.querySelector(".name").value,
    unit: tr.querySelector(".unit").value,
    qty: tr.querySelector(".qty").value,
    amt: tr.querySelector(".amount").textContent
  }));

  const sub = subTotalEl.textContent;
  const tax = taxEl.textContent;
  const total = grandTotalEl.textContent;

  const infoRows = [
    ["å®›å…ˆ", `<span style="font-weight:900">æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</span><br/><span style="font-size:11px;color:#555">ã€’185-0032 æ±äº¬éƒ½å›½åˆ†å¯ºå¸‚æ—¥å‰ç”º2-34-14 2Gå·å®¤</span>`],
    ["ç´å“æ›¸ç•ªå·", esc(docNo) || "â€”"],
    ["ç´å“æ—¥", esc(docDate) || "â€”"],
    ["å§“å", esc(author) || "â€”"],
    ["å±‹å·", esc(shop) || "â€”"],
    ["TEL", esc(tel) || "â€”"],
    addr ? ["ä½æ‰€", esc(addr)] : null
  ].filter(Boolean).map(([k,v])=>`
    <tr>
      <td class="k">${k}</td>
      <td class="v">${v}</td>
    </tr>
  `).join("");

  const rowsHTML = rows.map(r=>`
    <tr>
      <td class="c">${esc(r.no)}</td>
      <td class="name">${esc(r.name)}</td>
      <td class="r">${esc(r.unit)}</td>
      <td class="r">${esc(r.qty)}</td>
      <td class="r">${r.amt}</td>
    </tr>
  `).join("");

  return `<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${esc(makeName().replace(".pdf",""))}</title>
<style>
  @page{size:A4;margin:14mm}
  *{box-sizing:border-box}
  body{
    margin:0;
    padding:24px 28px;
    font-family:"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",system-ui,sans-serif;
    font-size:13px;
    color:#111;
    background:#fff;
  }
  .header{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
  .logo{height:28px;width:auto}
  h1{margin:0;font-size:22px;letter-spacing:.3px}
  .co{font-size:12px;color:#555;margin-top:3px}
  .info{width:100%;border-collapse:collapse;margin:12px 0 14px;}
  .info td{border:1px solid #ccc;padding:6px 8px;vertical-align:top;}
  .info td.k{width:120px;white-space:nowrap;color:#555;font-weight:800}
  .items{width:100%;border-collapse:collapse;table-layout:fixed;margin:0 0 12px;}
  .items th{background:#efefef;border:1px solid #aaa;padding:7px 7px;font-size:12px;white-space:nowrap;text-align:left}
  .items td{border:1px solid #aaa;padding:6px 7px;font-size:12px;vertical-align:middle}
  .c{text-align:center}
  .r{text-align:right}
  /* âœ… å…³é”®ï¼šå“ååˆ—å®½ï¼Œå…¶ä»–åˆ—å›ºå®šå®½ â€” å’Œä½ æ‰“å°ç‰ˆä¸€è‡´ */
  .col-no{width:36px}
  .col-unit{width:100px}
  .col-qty{width:65px}
  .col-amt{width:115px}
  .name{word-break:break-word}
  .sum-wrap{display:flex;justify-content:flex-end}
  .sum{width:260px;border:1px solid #ccc;border-radius:6px;padding:8px 12px}
  .sumrow{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #e5e7eb;font-size:12px}
  .sumrow:last-child{border-bottom:none}
  .sumrow .k{font-weight:800}
  .sumrow .v{font-weight:900}
  /* Mobile preview button (not in PDF) */
  .bar{margin-top:16px}
  .btn{
    display:block;
    width:100%;
    padding:16px;
    border:0;
    border-radius:12px;
    background:#0ea5a4;
    color:#fff;
    font-size:16px;
    font-weight:800;
    cursor:pointer;
    -webkit-tap-highlight-color:transparent;
  }
  .hint{margin-top:8px;text-align:center;color:#888;font-size:11px;line-height:1.6}
  @media print{ .bar{display:none} }
</style>
</head>
<body>
  <div class="header">
    <img class="logo" src="cleon-logo.PNG" alt="ClÃ©on"/>
    <div>
      <h1>ç´å“æ›¸</h1>
      <div class="co">æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</div>
    </div>
  </div>

  <table class="info">${infoRows}</table>

  <table class="items">
    <colgroup>
      <col class="col-no"/>
      <col/>
      <col class="col-unit"/>
      <col class="col-qty"/>
      <col class="col-amt"/>
    </colgroup>
    <thead>
      <tr>
        <th class="c">No</th>
        <th>å“å / ä½œå“å</th>
        <th class="r">å˜ä¾¡</th>
        <th class="r">æ•°é‡</th>
        <th class="r">é‡‘é¡</th>
      </tr>
    </thead>
    <tbody>${rowsHTML}</tbody>
  </table>

  <div class="sum-wrap">
    <div class="sum">
      <div class="sumrow"><div class="k">å°è¨ˆ</div><div class="v">${sub}</div></div>
      <div class="sumrow"><div class="k">æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰</div><div class="v">${tax}</div></div>
      <div class="sumrow"><div class="k">åˆè¨ˆ</div><div class="v">${total}</div></div>
    </div>
  </div>

  <div class="bar">
    <button class="btn" onclick="window.print()">ğŸ–¨ å°åˆ· / PDFã«ä¿å­˜</button>
    <div class="hint">ã‚¹ãƒãƒ›ã®å ´åˆï¼šå°åˆ· â†’ã€ŒPDFã«ä¿å­˜ã€ã¾ãŸã¯å…±æœ‰ã‹ã‚‰ä¿å­˜ã§ãã¾ã™</div>
  </div>
</body></html>`;
}

/* ===========================================================
  PDF generation (ONE layout)
  - Desktop: generate PDF blob and download
  - Mobile: try (1) Web Share (file) (2) direct download (Android) (3) open preview tab
=========================================================== */
const ua = navigator.userAgent;
const isIOS = /iP(hone|ad|od)/i.test(ua);
const isAndroid = /android/i.test(ua);

function supportsWebShareFile(){
  return !!(navigator.share && navigator.canShare);
}

async function htmlToPdfBlob(a4Html){
  // create hidden iframe, write A4 HTML, then html2pdf it (layout identical)
  const iframe = document.createElement("iframe");
  iframe.style.cssText = "position:fixed;left:-99999px;top:0;width:0;height:0;border:0;";
  document.body.appendChild(iframe);

  const doc = iframe.contentWindow.document;
  doc.open();
  doc.write(a4Html);
  doc.close();

  // wait images/fonts
  await new Promise(res => setTimeout(res, 350));

  const target = doc.body; // whole page
  const opt = {
    margin: [0,0,0,0],
    image: { type: "jpeg", quality: 0.98 },
    html2canvas: {
      scale: 2,
      useCORS: true,
      backgroundColor: "#ffffff",
      scrollY: 0,
      windowWidth: 794, // A4 px-ish
    },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
    pagebreak: { mode: ["css","legacy"] }
  };

  // html2pdf returns worker, we can output blob
  const worker = html2pdf().set(opt).from(target);
  const blob = await worker.outputPdf("blob");

  document.body.removeChild(iframe);
  return blob;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 4000);
}

function openPreview(blob){
  const url = URL.createObjectURL(blob);
  // open in a new tab: iOS/Android will show pdf viewer; user can save/share
  window.open(url, "_blank");
  setTimeout(()=> URL.revokeObjectURL(url), 8000);
}

async function shareFile(blob, filename){
  const file = new File([blob], filename, { type: "application/pdf" });
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    await navigator.share({ files: [file], title: filename, text: "ç´å“æ›¸PDF" });
    return true;
  }
  return false;
}

async function handlePDF(){
  const btn = document.getElementById("pdfBtn");
  const hint = document.getElementById("pdfHint");
  btn.disabled = true;
  hint.textContent = "PDFã‚’ä½œæˆä¸­â€¦";

  clearPH();

  try{
    if (!window.html2pdf) {
      // fallback: open print-like page
      const w = window.open("", "_blank");
      if (!w) throw new Error("popup blocked");
      w.document.open();
      w.document.write(buildA4HTML());
      w.document.close();
      hint.textContent = "";
      return;
    }

    const a4 = buildA4HTML();
    const blob = await htmlToPdfBlob(a4);
    const filename = makeName();

    // âœ… Best effort across devices
    // 1) Web Share with file (works on many iOS/Android modern browsers)
    if ((isIOS || isAndroid) && supportsWebShareFile()) {
      const ok = await shareFile(blob, filename).catch(()=>false);
      if (ok) { hint.textContent = ""; return; }
    }

    // 2) Android often supports direct download
    if (isAndroid) {
      downloadBlob(blob, filename);
      hint.textContent = "";
      return;
    }

    // 3) Desktop direct download
    if (!isIOS) {
      downloadBlob(blob, filename);
      hint.textContent = "";
      return;
    }

    // 4) iOS Safari: cannot reliably force download â†’ open preview
    openPreview(blob);
    hint.textContent = "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹ãã¾ã—ãŸï¼ˆå…±æœ‰/ä¿å­˜ã‹ã‚‰PDFä¿å­˜ã§ãã¾ã™ï¼‰";
  }catch(e){
    console.error(e);
    // last fallback: open A4 page and let user print/save
    const w = window.open("", "_blank");
    if (w){
      w.document.open();
      w.document.write(buildA4HTML());
      w.document.close();
      hint.textContent = "å°åˆ·ç”»é¢ã‹ã‚‰PDFä¿å­˜ã§ãã¾ã™ã€‚";
    }else{
      alert("PDFä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¨±å¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
    }
  }finally{
    restorePH();
    btn.disabled = false;
    setTimeout(()=>{ hint.textContent = ""; }, 5000);
  }
}
document.getElementById("pdfBtn").addEventListener("click", handlePDF);

/* ===========================================================
  Init
=========================================================== */
const d = new Date();
document.getElementById("docDate").value =
  `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
addRows(6);
</script>
</body>
</html>
