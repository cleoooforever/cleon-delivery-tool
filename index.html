<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" />
  <title>ç´å“æ›¸ | æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</title>

  <style>
    /* ============================================================
       STYLE ARCHITECTURE (v3)
       â‘  Base / Desktop screen  (è¡¨æ ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ, å¸¸ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
       â‘¡ .mobile ã‚¯ãƒ©ã‚¹ä»˜ä¸æ™‚ã®ã¿ ã‚«ãƒ¼ãƒ‰è¡¨ç¤º  (JSã§ä»˜ä¸)
       â‘¢ @media print  â†’  A4 è¡¨æ ¼ï¼ˆæ‰“å°ç‰ˆï¼‰
       â‘£ .pdf-page ã‚¯ãƒ©ã‚¹  â†’  æ‰“å°å°‚ç”¨æ–°çª“å£ã®ã‚¹ã‚¿ã‚¤ãƒ«
    ============================================================ */

    :root {
      --bg: #f6f7f9;
      --card: #fff;
      --text: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --accent: #0ea5a4;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { width: 100%; max-width: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-text-size-adjust: 100%;
    }

    /* â”€â”€â”€ Layout â”€â”€â”€ */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px 16px 64px; }

    .topbar {
      display: flex; gap: 10px; flex-wrap: wrap;
      align-items: center; justify-content: space-between;
      margin: 10px 0 16px;
    }
    .brand { display: flex; flex-direction: column; gap: 4px; }
    .brand h1 { margin: 0; font-size: 26px; letter-spacing: .5px; }
    .brandline { display: flex; align-items: center; gap: 14px; }
    .logo { height: 48px; width: auto; display: block; }
    .sub { color: var(--muted); font-size: 13px; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button {
      border: 1px solid var(--line); background: #fff;
      padding: 10px 14px; border-radius: 12px;
      cursor: pointer; font-weight: 600; font-size: 14px;
      -webkit-tap-highlight-color: transparent;
    }
    button.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    button:active:not(:disabled) { transform: translateY(1px); }
    .btn-mini { padding: 8px 12px; border-radius: 12px; font-weight: 700; }
    .hint { font-size: 12px; color: var(--muted); }

    .grid {
      display: grid;
      grid-template-columns: minmax(320px, 400px) 1fr;
      gap: 14px; align-items: start;
    }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background: var(--card); border: 1px solid var(--line);
      border-radius: 18px; padding: 16px;
      box-shadow: 0 8px 22px rgba(0,0,0,.04);
    }
    .sec-title {
      display: flex; align-items: baseline; justify-content: space-between;
      gap: 12px; flex-wrap: wrap;
      border-bottom: 1px solid var(--line);
      padding-bottom: 10px; margin-bottom: 12px;
    }
    .sec-title h2 { margin: 0; font-size: 18px; }
    .small { font-size: 12px; color: var(--muted); }

    /* â”€â”€â”€ åŸºæœ¬æƒ…å ± rows â€” Desktop default â”€â”€â”€ */
    .row {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 8px; align-items: center; margin: 8px 0;
    }
    .row label { color: var(--muted); font-size: 13px; }

    /* â”€â”€â”€ Inputs â”€â”€â”€ */
    input, textarea, select {
      width: 100%; min-width: 0;
      border: 1px solid var(--line); border-radius: 12px;
      padding: 10px 12px; font-size: 16px; /* 16px: iOS zoomé˜²æ­¢ */
      background: #fff; color: var(--text);
      font-family: inherit;
    }
    textarea { min-height: 72px; resize: vertical; }

    .dest-box { border: 1px solid var(--line); border-radius: 12px; padding: 10px 12px; background: #fff; }
    .dest-name { font-weight: 800; }
    .dest-addr { margin-top: 6px; color: var(--muted); font-size: 13px; line-height: 1.6; white-space: pre-line; }

    .pill {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      padding: 10px 12px; border: 1px dashed var(--line);
      border-radius: 14px; background: #fafafa; margin-top: 10px;
    }
    .footer-note { margin-top: 12px; color: var(--muted); font-size: 12px; line-height: 1.7; }

    /* â”€â”€â”€ Table (Desktop â€” always default) â”€â”€â”€ */
    .table-wrap {
      border: 1px solid var(--line); border-radius: 14px;
      background: #fff; overflow-x: auto; -webkit-overflow-scrolling: touch;
    }
    table {
      width: 100%; border-collapse: collapse;
      background: #fff; table-layout: fixed;
    }

    /*
      âœ… FIX: å“ååˆ—ã‚’å¤§ããã€æ•°å€¤åˆ—ã‚’é©åˆ‡ãªã‚µã‚¤ã‚ºã«å›ºå®š
      åˆè¨ˆå¹… = 48+[auto]+110+75+130+58 = 421px + name
    */
    col.no     { width: 48px; }
    col.name   { /* auto â€” takes remaining space */ }
    col.unit   { width: 110px; }
    col.qty    { width: 75px; }
    col.amount { width: 130px; }
    col.del    { width: 58px; }

    thead th {
      background: #f3f4f6; color: #111; font-weight: 700; font-size: 13px;
      padding: 10px 8px; border-bottom: 1px solid var(--line); white-space: nowrap;
    }
    tbody td {
      border-bottom: 1px solid var(--line); padding: 7px 8px;
      vertical-align: middle; font-size: 14px; overflow: hidden;
    }
    tbody tr:last-child td { border-bottom: none; }
    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .center { text-align: center; }

    /* âœ… FIX: tdå†…inputã¯å¿…ãšmin-width:0 */
    td input {
      width: 100%; min-width: 0;
      padding: 6px 8px; font-size: 14px;
      border-radius: 8px;
    }
    td.unitcell input, td.qtycell input { text-align: right; }

    .table-actions { margin-top: 10px; display: flex; justify-content: center; }
    .table-actions button { padding: 12px 18px; border-radius: 14px; font-weight: 800; }

    .sum {
      margin-top: 12px; display: grid;
      grid-template-columns: 1fr 300px; gap: 12px; align-items: start;
    }
    @media (max-width: 900px) { .sum { grid-template-columns: 1fr; } }
    .sum-box { border: 1px solid var(--line); border-radius: 14px; padding: 12px; background: #fff; }
    .sum-row {
      display: flex; justify-content: space-between; gap: 12px;
      padding: 8px 0; border-bottom: 1px solid var(--line);
      font-variant-numeric: tabular-nums;
    }
    .sum-row:last-child { border-bottom: none; }
    .sum-row .k { color: #111; font-weight: 700; }
    .sum-row .v { font-weight: 800; }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       âœ… FIX B: Mobile card layout â€” JSã§ body.is-mobile ä»˜ä¸æ™‚ã®ã¿æœ‰åŠ¹
       ã“ã‚Œã«ã‚ˆã‚Š Safari ã® media query èª¤åˆ¤å®šã‚’å›é¿
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body.is-mobile .row {
      grid-template-columns: 1fr;
      gap: 4px; align-items: stretch; margin: 10px 0;
    }
    body.is-mobile .row label { font-size: 12px; font-weight: 600; color: var(--muted); }

    body.is-mobile .table-wrap { overflow: visible; border: 0; background: transparent; }
    body.is-mobile table { min-width: 0; background: transparent; }
    body.is-mobile table,
    body.is-mobile thead,
    body.is-mobile tbody,
    body.is-mobile tr,
    body.is-mobile td { display: block; width: 100%; }
    body.is-mobile thead { display: none; }

    body.is-mobile tbody tr {
      background: #fff; border: 1px solid var(--line);
      border-radius: 16px; padding: 12px; margin: 10px 0;
      box-shadow: 0 8px 22px rgba(0,0,0,.04);
    }
    body.is-mobile tbody td { border-bottom: 0; padding: 6px 0; overflow: visible; }

    body.is-mobile tbody td:nth-child(1) {
      padding-top: 0; font-weight: 800; color: #111;
      display: flex; justify-content: center;
    }
    body.is-mobile tbody td:nth-child(2) { display: block; }
    body.is-mobile tbody td:nth-child(2)::before {
      content: "å“å / ä½œå“å"; display: block;
      color: var(--muted); font-weight: 700; font-size: 12px; margin-bottom: 6px;
    }
    body.is-mobile tbody td:nth-child(2) input { width: 100%; }
    body.is-mobile tbody td:nth-child(3),
    body.is-mobile tbody td:nth-child(4),
    body.is-mobile tbody td:nth-child(5),
    body.is-mobile tbody td:nth-child(6) {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
    }
    body.is-mobile tbody td:nth-child(3)::before { content: "å˜ä¾¡";   color: var(--muted); font-weight: 700; font-size: 12px; flex: 0 0 auto; }
    body.is-mobile tbody td:nth-child(4)::before { content: "æ•°é‡";   color: var(--muted); font-weight: 700; font-size: 12px; flex: 0 0 auto; }
    body.is-mobile tbody td:nth-child(5)::before { content: "é‡‘é¡";   color: var(--muted); font-weight: 700; font-size: 12px; flex: 0 0 auto; }
    body.is-mobile tbody td:nth-child(6)::before { content: "å‰Šé™¤";   color: var(--muted); font-weight: 700; font-size: 12px; flex: 0 0 auto; }
    body.is-mobile tbody td:nth-child(3) input,
    body.is-mobile tbody td:nth-child(4) input { width: 58%; text-align: right; }
    body.is-mobile tbody td:nth-child(5) {
      padding-top: 10px; border-top: 1px dashed var(--line); margin-top: 6px;
    }
    body.is-mobile .amount { font-weight: 900; }
    body.is-mobile tbody td:nth-child(6) button { padding: 10px 14px; border-radius: 14px; font-weight: 900; }

    /* â”€â”€â”€ @media print (ç³»çµ±æ‰“å°, A4) â”€â”€â”€ */
    @page { size: A4; margin: 12mm; }
    @media print {
      body { background: #fff; }
      .wrap { max-width: none; padding: 0; }
      .actions, .pill, .table-actions, .footer-note { display: none !important; }
      .card { box-shadow: none; border: 0; border-radius: 0; padding: 0; }
      .grid { display: block !important; }
      .topbar { margin-bottom: 14px; }

      .table-wrap { border: 1px solid #aaa; border-radius: 0; overflow: visible !important; background: #fff !important; }
      table { display: table !important; width: 100% !important; border-collapse: collapse !important; table-layout: fixed !important; min-width: 0 !important; }
      col.no     { width: 38px !important; }
      col.unit   { width: 100px !important; }
      col.qty    { width: 65px !important; }
      col.amount { width: 115px !important; }
      col.del    { width: 0 !important; display: none !important; }

      thead { display: table-header-group !important; }
      tbody { display: table-row-group !important; }
      tr    { display: table-row !important; page-break-inside: avoid !important; }
      th, td { display: table-cell !important; }
      td::before { content: none !important; }
      tbody tr { box-shadow: none !important; border: 0 !important; border-radius: 0 !important; padding: 0 !important; margin: 0 !important; background: #fff !important; }
      thead th { background: #efefef !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      tbody td { border: 1px solid #aaa !important; padding: 6px 8px !important; overflow: hidden !important; vertical-align: middle !important; font-size: 12px !important; }
      th:last-child, td:last-child { display: none !important; }

      input, textarea, select { border: 0 !important; padding: 0 !important; font-size: 12px !important; background: transparent !important; -webkit-appearance: none; appearance: none; box-shadow: none !important; }

      .row { grid-template-columns: 140px 1fr !important; gap: 6px !important; align-items: center !important; margin: 5px 0 !important; }
      .sum { grid-template-columns: 1fr !important; }
      .sum-box { width: 260px; margin-left: auto; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="brandline">
        <img src="cleon-logo.PNG" alt="ClÃ©on arts &amp; trade" class="logo" />
        <div>
          <h1>ç´å“æ›¸</h1>
          <div class="sub"><b>æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</b>ã€€ï½œã€€PDFã¯å³ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã§ãã¾ã™ã€‚</div>
        </div>
      </div>
    </div>
    <div class="actions">
      <button type="button" class="btn-mini" id="clearBtn">å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button type="button" class="primary btn-mini" id="pdfBtn">ğŸ“„ PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button type="button" class="btn-mini" id="printBtn">ğŸ–¨ å°åˆ·</button>
      <span class="hint" id="pdfHint"></span>
    </div>
  </div>

  <div id="pdfRoot">
    <div class="grid">

      <!-- LEFT -->
      <div class="card">
        <div class="sec-title">
          <h2>åŸºæœ¬æƒ…å ±</h2>
          <div class="small">ä½œè€…ã•ã¾ãŒå…¥åŠ› â†’ PDFä¿å­˜ â†’ ãƒ¡ãƒ¼ãƒ«/LINEç­‰ã§é€ä»˜</div>
        </div>

        <div class="row">
          <label>å®›å…ˆ</label>
          <div class="dest-box">
            <div class="dest-name">æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</div>
            <div class="dest-addr">ã€’185-0032
æ±äº¬éƒ½å›½åˆ†å¯ºå¸‚æ—¥å‰ç”º2-34-14 2Gå·å®¤</div>
          </div>
        </div>

        <div class="row">
          <label>ç´å“æ›¸ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
          <input id="docNo" placeholder="ä¾‹ï¼š2026-001" data-ph="ä¾‹ï¼š2026-001" />
        </div>
        <div class="row">
          <label>ç´å“æ—¥</label>
          <input id="docDate" type="date" />
        </div>
        <div class="row">
          <label>å§“å</label>
          <input id="authorName" placeholder="ä¾‹ï¼šæ¾„å’Œ èŠ±å­" data-ph="ä¾‹ï¼šæ¾„å’Œ èŠ±å­" />
        </div>
        <div class="row">
          <label>å±‹å·</label>
          <input id="shopName" placeholder="ä¾‹ï¼šatelier â—‹â—‹" data-ph="ä¾‹ï¼šatelier â—‹â—‹" />
        </div>
        <div class="row">
          <label>TEL</label>
          <input id="tel" placeholder="ä¾‹ï¼š090-xxxx-xxxx" data-ph="ä¾‹ï¼š090-xxxx-xxxx" />
        </div>
        <div class="row">
          <label>ä½æ‰€ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="addr" placeholder="ä¾‹ï¼šã€’xxx-xxxx æ±äº¬éƒ½â€¦" data-ph="ä¾‹ï¼šã€’xxx-xxxx æ±äº¬éƒ½â€¦"></textarea>
        </div>

        <div class="pill">
          <span>å…¥åŠ›æ–¹å¼ï¼š</span>
          <select id="mode">
            <option value="taxin" selected>ãŠã™ã™ã‚ï¼šç¨è¾¼ï¼ˆæ¶ˆè²»ç¨10%è¾¼ï¼‰ã§å…¥åŠ›</option>
            <option value="taxex">ç¨æŠœï¼ˆæ¶ˆè²»ç¨ã‚’åˆ¥è¨ˆç®—ï¼‰ã§å…¥åŠ›</option>
          </select>
          <span class="small">ç¨ç‡ï¼š<b>10%</b>ï½œç«¯æ•°ï¼š<b>å››æ¨äº”å…¥</b></span>
        </div>

        <div class="footer-note">
          â€»ã€Œç¨è¾¼ï¼ˆ10%è¾¼ï¼‰ã€ã‚’é¸ã¶ã¨ã€ä½œè€…ã•ã¾ã¯<b>ç¨è¾¼å˜ä¾¡</b>ã ã‘å…¥åŠ›ã™ã‚Œã°OKã§ã™ã€‚<br/>
          å½“ã‚µã‚¤ãƒˆã¯ClÃ©onå°‚ç”¨ã®å†…éƒ¨ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å…¥åŠ›æƒ…å ±ã¯å¤–éƒ¨ã¸æµå‡ºã—ã¾ã›ã‚“ã€‚
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="sec-title">
          <h2>æ˜ç´°</h2>
          <div class="small">å˜ä¾¡ Ã— æ•°é‡ â†’ é‡‘é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</div>
        </div>

        <div class="table-wrap">
          <table id="itemsTable">
            <colgroup>
              <col class="no">
              <col class="name">
              <col class="unit">
              <col class="qty">
              <col class="amount">
              <col class="del">
            </colgroup>
            <thead>
              <tr>
                <th class="center">No</th>
                <th>å“å / ä½œå“å</th>
                <th class="num">å˜ä¾¡</th>
                <th class="num">æ•°é‡</th>
                <th class="num">é‡‘é¡</th>
                <th class="center">å‰Šé™¤</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="table-actions">
          <button type="button" class="btn-mini" id="addRowBtn">ï¼‹ è¡Œã‚’è¿½åŠ </button>
        </div>

        <div class="sum">
          <div class="footer-note">
            â€» é‡‘é¡ã¯è‡ªå‹•è¨ˆç®—ã§ã™ã€‚ã€ŒPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§PDFãŒä½œæˆã§ãã¾ã™ã€‚<br/>
            â€» ç¨è¾¼å…¥åŠ›æ™‚ï¼šåˆè¨ˆï¼ˆç¨è¾¼ï¼‰ã¯å…¥åŠ›é‡‘é¡ã®åˆç®—ã€å†…è¨³ã¨ã—ã¦å°è¨ˆï¼ˆç¨æŠœï¼‰ã¨æ¶ˆè²»ç¨ã‚’ç®—å‡ºã—ã¾ã™ã€‚
          </div>
          <div class="sum-box">
            <div class="sum-row"><div class="k">å°è¨ˆ</div><div class="v" id="subTotal">0 å††</div></div>
            <div class="sum-row"><div class="k">æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰</div><div class="v" id="tax">0 å††</div></div>
            <div class="sum-row"><div class="k">åˆè¨ˆ</div><div class="v" id="grandTotal">0 å††</div></div>
          </div>
        </div>
      </div>

    </div>
  </div><!-- /pdfRoot -->
</div><!-- /wrap -->

<script>
/* ============================================================
   Helpers
============================================================ */
const yen    = n => (Number.isFinite(n) ? n : 0).toLocaleString("ja-JP") + " å††";
const toInt  = v => { const n = Number(String(v ?? "").replace(/[^\d.-]/g, "")); return Number.isFinite(n) ? n : 0; };
const roundY = n => Math.round(n);

const _phBackup = new Map();
function clearPH() {
  document.querySelectorAll("[data-ph], input.name, input.unit, input.qty").forEach(el => {
    _phBackup.set(el, el.getAttribute("placeholder") || "");
    el.setAttribute("placeholder", "");
  });
}
function restorePH() {
  _phBackup.forEach((v, el) => { try { el.setAttribute("placeholder", v); } catch(e){} });
  _phBackup.clear();
}

/* ============================================================
   âœ… FIX B: JS-based mobile detection (Safari safe)
   window.innerWidth ã¯ iOS Safari ã§ä¿¡é ¼æ€§ãŒé«˜ã„
============================================================ */
function checkMobile() {
  if (window.innerWidth <= 620) {
    document.body.classList.add("is-mobile");
  } else {
    document.body.classList.remove("is-mobile");
  }
}
checkMobile();
window.addEventListener("resize", checkMobile);

/* ============================================================
   DOM refs
============================================================ */
const tbody      = document.getElementById("tbody");
const modeSel    = document.getElementById("mode");
const subTotalEl = document.getElementById("subTotal");
const taxEl      = document.getElementById("tax");
const grandTotalEl = document.getElementById("grandTotal");

/* ============================================================
   Table rows
============================================================ */
function makeRow(i) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="center no">${i}</td>
    <td class="namecell"><input class="name" placeholder="ä¾‹ï¼šã‚«ãƒƒãƒ—ã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­ / ãƒ–ãƒ­ãƒ¼ãƒ ãªã©" /></td>
    <td class="num unitcell"><input class="unit" inputmode="numeric" placeholder="0" /></td>
    <td class="num qtycell"><input class="qty"  inputmode="numeric" placeholder="1" value="1" /></td>
    <td class="num amount">0 å††</td>
    <td class="center"><button type="button" class="btn-mini del">Ã—</button></td>
  `;
  tr.querySelector(".del").addEventListener("click", () => { tr.remove(); renumber(); recalc(); });
  tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", recalc));
  return tr;
}

function renumber() {
  [...tbody.querySelectorAll("tr")].forEach((tr, i) => { tr.querySelector(".no").textContent = i + 1; });
}

function addRows(n) {
  const start = tbody.querySelectorAll("tr").length;
  for (let k = 0; k < n; k++) tbody.appendChild(makeRow(start + k + 1));
  recalc();
}

function recalc() {
  let sum = 0;
  [...tbody.querySelectorAll("tr")].forEach(tr => {
    const unit = toInt(tr.querySelector(".unit").value);
    const qty  = Math.max(0, toInt(tr.querySelector(".qty").value || 0));
    const amt  = roundY(unit * qty);
    tr.querySelector(".amount").textContent = yen(amt);
    sum += amt;
  });
  const rate = 0.10;
  const mode = modeSel.value;
  if (mode === "taxex") {
    const sub = roundY(sum), tax = roundY(sub * rate);
    subTotalEl.textContent = yen(sub); taxEl.textContent = yen(tax); grandTotalEl.textContent = yen(sub + tax);
  } else {
    const total = roundY(sum), sub = roundY(total / (1 + rate)), tax = total - sub;
    subTotalEl.textContent = yen(sub); taxEl.textContent = yen(tax); grandTotalEl.textContent = yen(total);
  }
}

document.getElementById("addRowBtn").addEventListener("click", () => addRows(1));
modeSel.addEventListener("change", recalc);

/* ============================================================
   Reset
============================================================ */
document.getElementById("clearBtn").addEventListener("click", () => {
  if (!confirm("å…¥åŠ›å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  ["docNo","authorName","shopName","tel","addr"].forEach(id => document.getElementById(id).value = "");
  const d = new Date();
  document.getElementById("docDate").value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  modeSel.value = "taxin";
  tbody.innerHTML = "";
  addRows(6);
});

/* ============================================================
   Print
============================================================ */
document.getElementById("printBtn").addEventListener("click", () => {
  clearPH(); window.print(); setTimeout(restorePH, 1500);
});

/* ============================================================
   Device detection
============================================================ */
const ua = navigator.userAgent;
const isIOS     = /iP(hone|ad|od)/i.test(ua);
const isAndroid = /android/i.test(ua);
const isMobileDev = isIOS || isAndroid;

/* ============================================================
   Filename
============================================================ */
function makeName() {
  const no  = (document.getElementById("docNo").value || "").trim();
  const au  = (document.getElementById("authorName").value || "").trim();
  const dt  = (document.getElementById("docDate").value || "").trim();
  const base = no ? `ç´å“æ›¸_${no}` : "ç´å“æ›¸";
  const tail = [au, dt].filter(Boolean).join("_");
  return (tail ? `${base}_${tail}` : base) + ".pdf";
}

/* ============================================================
   HTML escape
============================================================ */
function esc(s) {
  return String(s || "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/\n/g,"<br/>");
}

/* ============================================================
   âœ… FIX C+D: æ‰“å°å°‚ç”¨æ–°çª—å£
   iOS Safari + Android + html2pdfå¤±æ•—æ™‚ â†’ å…¨ã¦ã“ã¡ã‚‰
   æ–°çª—å£ = ç´”ç²‹ãªA4 HTMLã€css tableå›ºå®šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œä¿å­˜ã€ã‚’æŠ¼ã™
============================================================ */
function openPrintWindow() {
  const docNo   = document.getElementById("docNo").value;
  const docDate = document.getElementById("docDate").value;
  const author  = document.getElementById("authorName").value;
  const shop    = document.getElementById("shopName").value;
  const tel     = document.getElementById("tel").value;
  const addr    = document.getElementById("addr").value;

  const rows = [...tbody.querySelectorAll("tr")].map(tr => ({
    no:   tr.querySelector(".no").textContent,
    name: tr.querySelector(".name").value,
    unit: tr.querySelector(".unit").value,
    qty:  tr.querySelector(".qty").value,
    amt:  tr.querySelector(".amount").textContent,
  }));
  const sub   = subTotalEl.textContent;
  const tax   = taxEl.textContent;
  const total = grandTotalEl.textContent;

  // âœ… FIX: å“ååˆ—ã‚’åºƒãå–ã‚‹ table-layout:fixed + colå¹…æŒ‡å®š
  const rowsHTML = rows.map(r => `
    <tr>
      <td style="text-align:center;width:36px">${esc(r.no)}</td>
      <td>${esc(r.name)}</td>
      <td style="text-align:right;width:100px">${esc(r.unit)}</td>
      <td style="text-align:right;width:60px">${esc(r.qty)}</td>
      <td style="text-align:right;width:110px">${r.amt}</td>
    </tr>`).join("");

  const infoRows = [
    ["å®›å…ˆ", `<span style="font-weight:800">æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</span><br/><span style="font-size:11px;color:#555">ã€’185-0032 æ±äº¬éƒ½å›½åˆ†å¯ºå¸‚æ—¥å‰ç”º2-34-14 2Gå·å®¤</span>`],
    ["ç´å“æ›¸ç•ªå·", esc(docNo) || "â€”"],
    ["ç´å“æ—¥",     esc(docDate) || "â€”"],
    ["å§“å",       esc(author) || "â€”"],
    ["å±‹å·",       esc(shop) || "â€”"],
    ["TEL",        esc(tel) || "â€”"],
    addr ? ["ä½æ‰€", esc(addr)] : null,
  ].filter(Boolean).map(([k,v]) => `
    <tr>
      <td style="color:#555;font-weight:700;white-space:nowrap;width:120px;vertical-align:top;padding:5px 8px;border:1px solid #ccc">${k}</td>
      <td style="padding:5px 8px;border:1px solid #ccc">${v}</td>
    </tr>`).join("");

  const pw = window.open("", "_blank");
  if (!pw) {
    alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  pw.document.write(`<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${esc(makeName().replace(".pdf",""))}</title>
<style>
  @page{size:A4;margin:14mm}
  *{box-sizing:border-box}
  body{
    margin:0;padding:24px 28px;
    font-family:"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",system-ui,sans-serif;
    font-size:13px;color:#111;background:#fff;
  }
  /* header */
  .header{display:flex;align-items:center;gap:12px;margin-bottom:18px;}
  .header h1{margin:0;font-size:22px;letter-spacing:.3px}
  .header .co{font-size:12px;color:#555;margin-top:3px}
  /* info table */
  .info-tbl{width:100%;border-collapse:collapse;margin-bottom:16px;}
  /* items table */
  .items-tbl{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:14px;}
  .items-tbl th{background:#efefef;font-size:12px;padding:7px 7px;border:1px solid #aaa;white-space:nowrap;}
  .items-tbl td{border:1px solid #aaa;padding:6px 7px;font-size:12px;vertical-align:middle;}
  /* sum */
  .sum-wrap{display:flex;justify-content:flex-end;margin-bottom:16px;}
  .sum-box{width:260px;border:1px solid #ccc;border-radius:4px;padding:8px 12px;}
  .sum-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #e5e7eb;font-size:12px;}
  .sum-row:last-child{border-bottom:none}
  .sum-row .k{font-weight:700}.sum-row .v{font-weight:800}
  /* button */
  .save-btn{
    display:block;width:calc(100% - 0px);margin:20px 0 0;
    padding:16px;background:#0ea5a4;color:#fff;
    border:0;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;
    -webkit-tap-highlight-color:transparent;
  }
  .save-btn:active{opacity:.85}
  .hint-txt{text-align:center;color:#888;font-size:11px;margin-top:8px}
  @media print{.save-btn,.hint-txt{display:none}}
</style>
</head><body>
<div class="header">
  <div>
    <h1>ç´å“æ›¸</h1>
    <div class="co">æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</div>
  </div>
</div>

<table class="info-tbl">${infoRows}</table>

<table class="items-tbl">
  <colgroup>
    <col style="width:36px">
    <col>
    <col style="width:100px">
    <col style="width:60px">
    <col style="width:110px">
  </colgroup>
  <thead><tr>
    <th style="text-align:center">No</th>
    <th>å“å / ä½œå“å</th>
    <th style="text-align:right">å˜ä¾¡</th>
    <th style="text-align:right">æ•°é‡</th>
    <th style="text-align:right">é‡‘é¡</th>
  </tr></thead>
  <tbody>${rowsHTML}</tbody>
</table>

<div class="sum-wrap">
  <div class="sum-box">
    <div class="sum-row"><div class="k">å°è¨ˆ</div><div class="v">${sub}</div></div>
    <div class="sum-row"><div class="k">æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰</div><div class="v">${tax}</div></div>
    <div class="sum-row"><div class="k">åˆè¨ˆ</div><div class="v">${total}</div></div>
  </div>
</div>

<button class="save-btn" onclick="window.print()">ğŸ–¨ã€€å°åˆ· / PDFã«ä¿å­˜</button>
<p class="hint-txt">ã€Œå°åˆ·ã€â†’ã€ŒPDFã«ä¿å­˜ã€ã§PDFã¨ã—ã¦ä¿å­˜ã§ãã¾ã™</p>
</body></html>`);
  pw.document.close();
}

/* ============================================================
   âœ… Main PDF handler
   - iOS/Android â†’ æ‰“å°å°‚ç”¨æ–°çª—å£ï¼ˆç¢ºå®Ÿï¼‰
   - Desktop     â†’ html2pdf ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€å¤±æ•—æ™‚ã¯æ–°çª—å£fallback
============================================================ */
async function handlePDF() {
  // iOSãƒ»Android ã¯å…¨ã¦æ–°çª—å£ print
  if (isMobileDev) {
    openPrintWindow();
    return;
  }

  if (!window.html2pdf) {
    openPrintWindow(); return;
  }

  const pdfBtn  = document.getElementById("pdfBtn");
  const pdfHint = document.getElementById("pdfHint");
  pdfBtn.disabled = true;
  pdfHint.textContent = "PDFã‚’ä½œæˆä¸­â€¦";
  clearPH();

  /* âœ… Build a clean A4-width clone with pdf-safe inline styles */
  const src    = document.getElementById("pdfRoot");
  const clone  = src.cloneNode(true);

  // Remove interactive elements
  clone.querySelectorAll(".del, .table-actions, .pill, .footer-note, .actions").forEach(e => e.remove());

  // ---- Force table display on clone ----
  const tbl = clone.querySelector("table");
  if (tbl) {
    tbl.style.cssText = "display:table!important;width:100%!important;border-collapse:collapse!important;table-layout:fixed!important;min-width:0!important;";
    const thead = tbl.querySelector("thead");
    if (thead) thead.style.cssText = "display:table-header-group!important;";
    const tbody2 = tbl.querySelector("tbody");
    if (tbody2) tbody2.style.cssText = "display:table-row-group!important;";
    tbl.querySelectorAll("tr").forEach(tr => {
      tr.style.cssText = "display:table-row!important;box-shadow:none!important;border:0!important;border-radius:0!important;padding:0!important;margin:0!important;background:#fff!important;";
    });
    tbl.querySelectorAll("th,td").forEach(cell => {
      cell.style.display = "table-cell";
      cell.style.border = "1px solid #aaa";
      cell.style.padding = "6px 8px";
      cell.style.fontSize = "12px";
      cell.style.verticalAlign = "middle";
      cell.style.overflow = "hidden";
    });
    tbl.querySelectorAll("th").forEach(th => {
      th.style.background = "#efefef";
      th.style.fontWeight = "700";
    });
    // âœ… Fix col widths
    const cols = tbl.querySelectorAll("col");
    const widths = ["36px", "auto", "100px", "65px", "115px", "0px"];
    cols.forEach((c, i) => { c.style.width = widths[i] || "auto"; });
    // Hide del column
    tbl.querySelectorAll("th:last-child, td:last-child").forEach(e => e.style.display = "none");
  }

  // ---- Fix inputs â†’ show value as text ----
  clone.querySelectorAll("input, textarea, select").forEach(el => {
    el.style.cssText = "border:0!important;padding:0!important;font-size:12px!important;background:transparent!important;-webkit-appearance:none;appearance:none;box-shadow:none;width:100%;min-width:0;";
    el.setAttribute("placeholder", "");
  });

  // ---- Fix .row to 2-column ----
  clone.querySelectorAll(".row").forEach(row => {
    row.style.cssText = "display:grid;grid-template-columns:130px 1fr;gap:6px 8px;align-items:center;margin:5px 0;";
  });

  // ---- Fix .grid to single column ----
  const grid = clone.querySelector(".grid");
  if (grid) grid.style.cssText = "display:block;";

  // ---- Fix .card ----
  clone.querySelectorAll(".card").forEach(c => {
    c.style.cssText = "box-shadow:none;border:0;border-radius:0;padding:0;margin-bottom:16px;background:#fff;";
  });

  // ---- Fix .table-wrap ----
  const tw = clone.querySelector(".table-wrap");
  if (tw) tw.style.cssText = "border:1px solid #aaa;border-radius:0;overflow:visible;background:#fff;";

  // ---- Fix .sum ----
  const sumEl = clone.querySelector(".sum");
  if (sumEl) sumEl.style.cssText = "display:block;margin-top:10px;";
  const sb = clone.querySelector(".sum-box");
  if (sb) { sb.style.cssText = "width:260px;margin-left:auto;border:1px solid #ccc;border-radius:4px;padding:8px 10px;"; }

  // Wrap in A4 container
  const wrapper = document.createElement("div");
  wrapper.style.cssText = "background:#fff;width:794px;padding:30px 40px;font-family:system-ui,-apple-system,'Noto Sans JP','Hiragino Kaku Gothic ProN','Yu Gothic',sans-serif;font-size:13px;color:#111;";
  wrapper.appendChild(clone);

  const host = document.createElement("div");
  host.style.cssText = "position:fixed;left:-99999px;top:0;background:#fff;z-index:-1;";
  host.appendChild(wrapper);
  document.body.appendChild(host);

  try {
    await html2pdf().set({
      margin: [0,0,0,0],
      filename: makeName(),
      image: { type: "jpeg", quality: 0.97 },
      html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff", scrollY: 0, windowWidth: 794, width: 794 },
      jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
      pagebreak: { mode: ["css","legacy"] }
    }).from(wrapper).save();
  } catch(e) {
    console.error("html2pdf failed:", e);
    const go = confirm("PDFã®è‡ªå‹•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nå°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½¿ã£ã¦PDFã‚’ä¿å­˜ã™ã‚‹æ–¹æ³•ã§ã‚‚PDFä½œæˆã§ãã¾ã™ã€‚\nä»Šã™ãé–‹ãã¾ã™ã‹ï¼Ÿ");
    if (go) openPrintWindow();
  } finally {
    document.body.removeChild(host);
    restorePH();
    pdfBtn.disabled = false;
    pdfHint.textContent = "";
  }
}

document.getElementById("pdfBtn").addEventListener("click", handlePDF);

/* ============================================================
   Init
============================================================ */
const d = new Date();
document.getElementById("docDate").value =
  `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
addRows(6);
</script>
</body>
</html>
