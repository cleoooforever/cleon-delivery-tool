<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" />
  <title>ç´å“æ›¸ | æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#0ea5a4;
      --shadow:0 8px 22px rgba(0,0,0,.04);
    }
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ width:100%; max-width:100%; }
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",Roboto,sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-text-size-adjust:100%;
    }

    /* Layout */
    .wrap{ max-width:1100px; margin:0 auto; padding:18px 16px 64px; }
    .topbar{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      margin:10px 0 16px;
    }
    .brand{ display:flex; flex-direction:column; gap:4px; }
    .brandline{ display:flex; align-items:center; gap:14px; }
    .logo{ height:48px; width:auto; display:block; }
    .brand h1{ margin:0; font-size:26px; letter-spacing:.5px; }
    .sub{ color:var(--muted); font-size:13px; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    button{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      -webkit-tap-highlight-color:transparent;
    }
    button.primary{ background:var(--accent); border-color:var(--accent); color:#fff; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    button:active:not(:disabled){ transform:translateY(1px); }
    .btn-mini{ padding:8px 12px; border-radius:12px; font-weight:800; }
    .hint{ font-size:12px; color:var(--muted); }

    .grid{
      display:grid;
      grid-template-columns:minmax(320px, 400px) 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width:900px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .sec-title{
      display:flex; align-items:baseline; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      border-bottom:1px solid var(--line);
      padding-bottom:10px; margin-bottom:12px;
    }
    .sec-title h2{ margin:0; font-size:18px; }
    .small{ font-size:12px; color:var(--muted); }

    .row{
      display:grid;
      grid-template-columns:150px 1fr;
      gap:8px;
      align-items:center;
      margin:8px 0;
    }
    .row label{ color:var(--muted); font-size:13px; }

    input,textarea,select{
      width:100%;
      min-width:0;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      font-size:16px;
      background:#fff;
      color:var(--text);
      font-family:inherit;
    }
    textarea{ min-height:72px; resize:vertical; }

    input[type="date"]{
      max-width:100%;
      width:100%;
      min-width:0;
      -webkit-appearance:none;
      appearance:none;
    }

    .dest-box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
    }
    .dest-name{ font-weight:900; }
    .dest-addr{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
      white-space:pre-line;
    }

    .pill{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      padding:10px 12px;
      border:1px dashed var(--line);
      border-radius:14px;
      background:#fafafa;
      margin-top:10px;
    }
    .footer-note{ margin-top:12px; color:var(--muted); font-size:12px; line-height:1.7; }

    .table-wrap{
      border:1px solid var(--line);
      border-radius:14px;
      background:#fff;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    table{
      width:100%;
      border-collapse:collapse;
      background:#fff;
      table-layout:fixed;
    }

    col.no     { width:56px; }
    col.unit   { width:120px; }
    col.qty    { width:90px; }
    col.amount { width:130px; }
    col.del    { width:66px; }
    col.name   { width:auto; }

    thead th{
      background:#f3f4f6;
      color:#111;
      font-weight:800;
      font-size:13px;
      padding:10px 8px;
      border-bottom:1px solid var(--line);
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:8px 8px;
      vertical-align:middle;
      font-size:14px;
      overflow:hidden;
    }
    tbody tr:last-child td{ border-bottom:none; }
    .num{ text-align:right; font-variant-numeric:tabular-nums; }
    .center{ text-align:center; }

    td input{
      width:100%;
      min-width:0;
      padding:7px 10px;
      font-size:14px;
      border-radius:10px;
    }
    td.unitcell input, td.qtycell input{ text-align:right; }

    .table-actions{ margin-top:10px; display:flex; justify-content:center; }
    .table-actions button{ padding:12px 18px; border-radius:14px; font-weight:900; }

    .sum{
      margin-top:12px;
      display:grid;
      grid-template-columns:1fr 300px;
      gap:12px;
      align-items:start;
    }
    @media (max-width:900px){ .sum{ grid-template-columns:1fr; } }
    .sum-box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .sum-row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:8px 0;
      border-bottom:1px solid var(--line);
      font-variant-numeric:tabular-nums;
    }
    .sum-row:last-child{ border-bottom:none; }
    .sum-row .k{ color:#111; font-weight:800; }
    .sum-row .v{ font-weight:900; }
    .mode-badge{
      display:inline-block;
      font-size:12px;
      font-weight:800;
      padding:3px 10px;
      border-radius:20px;
      background:#e0f7f7;
      color:#0ea5a4;
      letter-spacing:.3px;
    }
    .mode-badge.taxex{
      background:#fff3e0;
      color:#d97706;
    }

    /* Mobile */
    body.is-mobile .row{
      grid-template-columns:1fr;
      gap:4px;
      align-items:stretch;
      margin:10px 0;
    }
    body.is-mobile .row label{
      font-size:12px;
      font-weight:700;
      color:var(--muted);
    }

    body.is-mobile .table-wrap{ overflow:visible; border:0; background:transparent; }
    body.is-mobile table{ min-width:0; background:transparent; }
    body.is-mobile table,
    body.is-mobile thead,
    body.is-mobile tbody,
    body.is-mobile tr,
    body.is-mobile td{ display:block; width:100%; }
    body.is-mobile thead{ display:none; }

    body.is-mobile tbody tr{
      background:#fff;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      margin:10px 0;
      box-shadow:var(--shadow);
    }
    body.is-mobile tbody td{ border-bottom:0; padding:6px 0; overflow:visible; }

    body.is-mobile tbody td:nth-child(1){
      padding-top:0;
      font-weight:900;
      color:#111;
      display:flex;
      justify-content:center;
    }
    body.is-mobile tbody td:nth-child(2)::before{
      content:"å“å / ä½œå“å";
      display:block;
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      margin-bottom:6px;
    }
    body.is-mobile tbody td:nth-child(3),
    body.is-mobile tbody td:nth-child(4),
    body.is-mobile tbody td:nth-child(5),
    body.is-mobile tbody td:nth-child(6){
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    body.is-mobile tbody td:nth-child(3)::before{ content:"å˜ä¾¡"; color:var(--muted); font-weight:800; font-size:12px; }
    body.is-mobile tbody td:nth-child(4)::before{ content:"æ•°é‡"; color:var(--muted); font-weight:800; font-size:12px; }
    body.is-mobile tbody td:nth-child(5)::before{ content:"é‡‘é¡"; color:var(--muted); font-weight:800; font-size:12px; }
    body.is-mobile tbody td:nth-child(6)::before{ content:"å‰Šé™¤"; color:var(--muted); font-weight:800; font-size:12px; }

    body.is-mobile tbody td:nth-child(3) input,
    body.is-mobile tbody td:nth-child(4) input{ width:60%; text-align:right; }

    body.is-mobile tbody td:nth-child(5){
      padding-top:10px;
      border-top:1px dashed var(--line);
      margin-top:6px;
    }
    body.is-mobile .amount{ font-weight:950; }

    body.is-mobile tbody td:nth-child(6) button{
      padding:10px 14px;
      border-radius:14px;
      font-weight:900;
    }

    body.is-mobile input[type="date"]{
      width:100%;
      max-width:100%;
      display:block;
    }

    /* Print */
    @page { size:A4; margin:12mm; }
    @media print{
      body{ background:#fff; }
      .wrap{ max-width:none; padding:0; }
      .actions, .pill, .table-actions, .footer-note { display:none !important; }
      .card{ box-shadow:none; border:0; border-radius:0; padding:0; }
      .grid{ display:block !important; }
      .topbar{ margin-bottom:14px; }

      .table-wrap{
        border:1px solid #aaa;
        border-radius:0;
        overflow:visible !important;
        background:#fff !important;
      }
      table{
        display:table !important;
        width:100% !important;
        border-collapse:collapse !important;
        table-layout:fixed !important;
        min-width:0 !important;
      }
      col.no     { width:38px !important; }
      col.unit   { width:100px !important; }
      col.qty    { width:65px !important; }
      col.amount { width:115px !important; }
      col.del    { width:0 !important; display:none !important; }

      thead{ display:table-header-group !important; }
      tbody{ display:table-row-group !important; }
      tr{ display:table-row !important; page-break-inside:avoid !important; }
      th,td{ display:table-cell !important; }
      td::before{ content:none !important; }
      tbody tr{
        box-shadow:none !important;
        border:0 !important;
        border-radius:0 !important;
        padding:0 !important;
        margin:0 !important;
        background:#fff !important;
      }
      thead th{
        background:#efefef !important;
        -webkit-print-color-adjust:exact;
        print-color-adjust:exact;
      }
      .mode-badge{
        -webkit-print-color-adjust:exact;
        print-color-adjust:exact;
      }
      tbody td{
        border:1px solid #aaa !important;
        padding:6px 8px !important;
        overflow:hidden !important;
        vertical-align:middle !important;
        font-size:12px !important;
      }
      th:last-child, td:last-child{ display:none !important; }

      input,textarea,select{
        border:0 !important;
        padding:0 !important;
        font-size:12px !important;
        background:transparent !important;
        -webkit-appearance:none;
        appearance:none;
        box-shadow:none !important;
      }

      .row{
        grid-template-columns:140px 1fr !important;
        gap:6px !important;
        align-items:center !important;
        margin:5px 0 !important;
      }
      .sum{ grid-template-columns:1fr !important; }
      .sum-box{ width:260px; margin-left:auto; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <div class="brand">
      <div class="brandline">
        <img src="cleon-logo.PNG" alt="ClÃ©on arts &amp; trade" class="logo" />
        <div>
          <h1>ç´å“æ›¸</h1>
          <div class="sub"><b>æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</b>ã€€ï½œã€€PDFã¯å³ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã§ãã¾ã™ã€‚</div>
        </div>
      </div>
    </div>
    <div class="actions">
      <button type="button" class="btn-mini" id="clearBtn">å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      <button type="button" class="primary btn-mini" id="pdfBtn">ğŸ“„ PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <button type="button" class="btn-mini" id="printBtn">ğŸ–¨ å°åˆ·</button>
      <span class="hint" id="pdfHint"></span>
    </div>
  </div>

  <div id="screenRoot">
    <div class="grid">

      <!-- LEFT -->
      <div class="card">
        <div class="sec-title">
          <h2>åŸºæœ¬æƒ…å ±</h2>
          <div class="small">ä½œè€…ã•ã¾ãŒå…¥åŠ› â†’ PDFä¿å­˜ â†’ ãƒ¡ãƒ¼ãƒ«/LINEç­‰ã§é€ä¿¡</div>
        </div>

        <div class="row">
          <label>å®›å…ˆ</label>
          <div class="dest-box">
            <div class="dest-name">æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</div>
            <div class="dest-addr">ã€’185-0032 æ±äº¬éƒ½å›½åˆ†å¯ºå¸‚æ—¥å‰ç”º2-34-14 2Gå·å®¤</div>
          </div>
        </div>

        <div class="row">
          <label>ç´å“æ›¸ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
          <input id="docNo" placeholder="ä¾‹ï¼š2026-001" data-ph="ä¾‹ï¼š2026-001" />
        </div>

        <div class="row">
          <label>ç´å“æ—¥</label>
          <input id="docDate" type="date" />
        </div>

        <div class="row">
          <label>å§“å</label>
          <input id="authorName" placeholder="ä¾‹ï¼šæ¾„å’Œ èŠ±å­" data-ph="ä¾‹ï¼šæ¾„å’Œ èŠ±å­" />
        </div>

        <div class="row">
          <label>å±‹å·</label>
          <input id="shopName" placeholder="ä¾‹ï¼šatelier " data-ph="ä¾‹ï¼šatelier " />
        </div>

        <div class="row">
          <label>TEL</label>
          <input id="tel" placeholder="ä¾‹ï¼š090-xxxx-xxxx" data-ph="ä¾‹ï¼š090-xxxx-xxxx" />
        </div>

        <div class="row">
          <label>ä½æ‰€ï¼ˆä»»æ„ï¼‰</label>
          <textarea id="addr" placeholder="ä¾‹ï¼šã€’xxx-xxxx æ±äº¬éƒ½â€¦" data-ph="ä¾‹ï¼šã€’xxx-xxxx æ±äº¬éƒ½â€¦"></textarea>
        </div>

        <div class="pill">
          <span>å…¥åŠ›æ–¹å¼ï¼š</span>
          <select id="mode">
            <option value="taxin" selected>ãŠã™ã™ã‚ï¼šç¨è¾¼ï¼ˆæ¶ˆè²»ç¨10%è¾¼ï¼‰ã§å…¥åŠ›</option>
            <option value="taxex">ç¨æŠœï¼ˆæ¶ˆè²»ç¨ã‚’åˆ¥è¨ˆç®—ï¼‰ã§å…¥åŠ›</option>
          </select>
          <span class="small">ç¨ç‡ï¼š<b>10%</b>ï½œç«¯æ•°ï¼š<b>å››æ¨äº”å…¥</b></span>
        </div>

        <div class="footer-note">
          â€»ã€Œç¨è¾¼ï¼ˆ10%è¾¼ï¼‰ã€ã‚’é¸ã¶ã¨ã€ä½œè€…ã•ã¾ã¯<b>ç¨è¾¼å˜ä¾¡</b>ã ã‘å…¥åŠ›ã™ã‚Œã°OKã§ã™ã€‚<br/>
          å½“ã‚µã‚¤ãƒˆã¯ClÃ©onå°‚ç”¨ã®å†…éƒ¨ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å…¥åŠ›æƒ…å ±ã¯å¤–éƒ¨ã«å…¬é–‹ã•ã‚Œã¾ã›ã‚“ã®ã§ã”å®‰å¿ƒãã ã•ã„ã€‚
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="sec-title">
          <h2>æ˜ç´°</h2>
          <div class="small">å˜ä¾¡ Ã— æ•°é‡ â†’ é‡‘é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</div>
        </div>

        <div class="table-wrap">
          <table id="itemsTable">
            <colgroup>
              <col class="no">
              <col class="name">
              <col class="unit">
              <col class="qty">
              <col class="amount">
              <col class="del">
            </colgroup>
            <thead>
              <tr>
                <th class="center">No</th>
                <th>å“å / ä½œå“å</th>
                <th class="num">å˜ä¾¡</th>
                <th class="num">æ•°é‡</th>
                <th class="num">é‡‘é¡</th>
                <th class="center">å‰Šé™¤</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div class="table-actions">
          <button type="button" class="btn-mini" id="addRowBtn">ï¼‹ è¿½åŠ </button>
        </div>

        <div class="sum">
          <div class="footer-note">
            â€» é‡‘é¡ã¯è‡ªå‹•è¨ˆç®—ã§ã™ã€‚ã€ŒPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§PDFãŒä½œæˆã§ãã¾ã™ã€‚<br/>
            â€» ç¨è¾¼å…¥åŠ›æ™‚ï¼šåˆè¨ˆï¼ˆç¨è¾¼ï¼‰ã¯å…¥åŠ›é‡‘é¡ã®åˆç®—ã€å†…è¨³ã¨ã—ã¦å°è¨ˆï¼ˆç¨æŠœï¼‰ã¨æ¶ˆè²»ç¨ã‚’ç®—å‡ºã—ã¾ã™ã€‚
          </div>

          <div class="sum-box">
            <div class="sum-row mode-row"><div class="k">å˜ä¾¡å…¥åŠ›æ–¹å¼</div><div class="v mode-badge" id="modeBadge">ç¨è¾¼ï¼ˆ10%è¾¼ï¼‰</div></div>
            <div class="sum-row"><div class="k">å°è¨ˆ</div><div class="v" id="subTotal">0 å††</div></div>
            <div class="sum-row"><div class="k">æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰</div><div class="v" id="tax">0 å††</div></div>
            <div class="sum-row"><div class="k">åˆè¨ˆ</div><div class="v" id="grandTotal">0 å††</div></div>
          </div>
        </div>

      </div>

    </div>
  </div>
</div>

<script>
/* ===========================================================
  PDF assets paths (same directory as index.html)
=========================================================== */
const FONT_REG_URL  = "./NotoSansJP-Regular.ttf";
const FONT_BOLD_URL = "./NotoSansJP-Bold.ttf";
const LOGO_URL      = "./cleon-logo.PNG";

/* ===========================================================
  Helpers
=========================================================== */
const yen = n => (Number.isFinite(n) ? n : 0).toLocaleString("ja-JP") + " å††";
const toInt = v => {
  const n = Number(String(v ?? "").replace(/[^\d.-]/g, ""));
  return Number.isFinite(n) ? n : 0;
};
const roundY = n => Math.round(n);

const _phBackup = new Map();
function clearPH(){
  document.querySelectorAll("[data-ph], input.name, input.unit, input.qty").forEach(el=>{
    _phBackup.set(el, el.getAttribute("placeholder") || "");
    el.setAttribute("placeholder","");
  });
}
function restorePH(){
  _phBackup.forEach((v,el)=>{ try{ el.setAttribute("placeholder", v); }catch(e){} });
  _phBackup.clear();
}

/* ===========================================================
  Mobile detection
=========================================================== */
function checkMobile(){
  if (window.innerWidth <= 620) document.body.classList.add("is-mobile");
  else document.body.classList.remove("is-mobile");
}
checkMobile();
window.addEventListener("resize", checkMobile);

/* ===========================================================
  DOM refs
=========================================================== */
const tbody      = document.getElementById("tbody");
const modeSel    = document.getElementById("mode");
const subTotalEl = document.getElementById("subTotal");
const taxEl      = document.getElementById("tax");
const grandTotalEl = document.getElementById("grandTotal");

/* ===========================================================
  Table rows
=========================================================== */
function makeRow(i){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="center no">${i}</td>
    <td class="namecell"><input class="name" placeholder="ä¾‹ï¼šã‚«ãƒƒãƒ—ã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­ / ãƒ–ãƒ­ãƒ¼ãƒ ãªã©" /></td>
    <td class="num unitcell"><input class="unit" inputmode="numeric" placeholder="0" /></td>
    <td class="num qtycell"><input class="qty" inputmode="numeric" placeholder="1" value="1" /></td>
    <td class="num amount">0 å††</td>
    <td class="center"><button type="button" class="btn-mini del">Ã—</button></td>
  `;
  tr.querySelector(".del").addEventListener("click", ()=>{ tr.remove(); renumber(); recalc(); });
  tr.querySelectorAll("input").forEach(inp=> inp.addEventListener("input", recalc));
  return tr;
}
function renumber(){
  [...tbody.querySelectorAll("tr")].forEach((tr,i)=>{ tr.querySelector(".no").textContent = i+1; });
}
function addRows(n){
  const start = tbody.querySelectorAll("tr").length;
  for (let k=0;k<n;k++) tbody.appendChild(makeRow(start+k+1));
  recalc();
}
function recalc(){
  let sum = 0;
  [...tbody.querySelectorAll("tr")].forEach(tr=>{
    const unit = toInt(tr.querySelector(".unit").value);
    const qty  = Math.max(0, toInt(tr.querySelector(".qty").value || 0));
    const amt  = roundY(unit * qty);
    tr.querySelector(".amount").textContent = yen(amt);
    sum += amt;
  });

  const rate = 0.10;
  const mode = modeSel.value;

  // Update mode badge
  const badge = document.getElementById("modeBadge");
  if (mode === "taxex") {
    badge.textContent = "ç¨æŠœï¼ˆæ¶ˆè²»ç¨10%åˆ¥ï¼‰";
    badge.classList.add("taxex");
  } else {
    badge.textContent = "ç¨è¾¼ï¼ˆæ¶ˆè²»ç¨10%è¾¼ï¼‰";
    badge.classList.remove("taxex");
  }

  if (mode === "taxex"){
    const sub = roundY(sum);
    const tax = roundY(sub * rate);
    subTotalEl.textContent = yen(sub);
    taxEl.textContent = yen(tax);
    grandTotalEl.textContent = yen(sub + tax);
  }else{
    const total = roundY(sum);
    const sub = roundY(total / (1 + rate));
    const tax = total - sub;
    subTotalEl.textContent = yen(sub);
    taxEl.textContent = yen(tax);
    grandTotalEl.textContent = yen(total);
  }
}
document.getElementById("addRowBtn").addEventListener("click", ()=> addRows(1));
modeSel.addEventListener("change", recalc);

/* ===========================================================
  Reset
=========================================================== */
document.getElementById("clearBtn").addEventListener("click", ()=>{
  if (!confirm("å…¥åŠ›å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  ["docNo","authorName","shopName","tel","addr"].forEach(id=> document.getElementById(id).value = "");
  const d = new Date();
  document.getElementById("docDate").value =
    `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
  modeSel.value = "taxin";
  tbody.innerHTML = "";
  addRows(6);
});

/* ===========================================================
  Print
=========================================================== */
document.getElementById("printBtn").addEventListener("click", ()=>{
  clearPH();
  window.print();
  setTimeout(restorePH, 1200);
});

/* ===========================================================
  Filename
=========================================================== */
function makeName(){
  const no = (document.getElementById("docNo").value || "").trim();
  const au = (document.getElementById("authorName").value || "").trim();
  const dt = (document.getElementById("docDate").value || "").trim();
  const base = no ? `ç´å“æ›¸_${no}` : "ç´å“æ›¸";
  const tail = [au, dt].filter(Boolean).join("_");
  return (tail ? `${base}_${tail}` : base) + ".pdf";
}

/* ===========================================================
  Helpers
=========================================================== */
function formatNumber(n){
  const v = Number(n || 0);
  return v.toLocaleString("ja-JP");
}

async function fetchAsBase64(url){
  const res = await fetch(url, { cache:"force-cache" });
  if (!res.ok) throw new Error("fetch failed: " + url + " (" + res.status + ")");
  const buf = await res.arrayBuffer();
  let binary = "";
  const bytes = new Uint8Array(buf);
  const chunk = 0x8000;
  for (let i = 0; i < bytes.length; i += chunk){
    binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
  }
  return btoa(binary);
}

function collectPdfData(){
  const docNo   = (document.getElementById("docNo").value || "").trim();
  const docDate = (document.getElementById("docDate").value || "").trim();
  const author  = (document.getElementById("authorName").value || "").trim();
  const shop    = (document.getElementById("shopName").value || "").trim();
  const tel     = (document.getElementById("tel").value || "").trim();
  const addr    = (document.getElementById("addr").value || "").trim();

  const rows = [...tbody.querySelectorAll("tr")].map(tr=>({
    no:   tr.querySelector(".no").textContent,
    name: (tr.querySelector(".name").value || "").trim(),
    unit: toInt(tr.querySelector(".unit").value),
    qty:  Math.max(0, toInt(tr.querySelector(".qty").value || 0)),
  })).map(r=>({ ...r, amt: roundY(r.unit * r.qty) }));

  const mode = modeSel.value;
  const rate = 0.10;
  const sum  = roundY(rows.reduce((a, r) => a + r.amt, 0));

  let sub = 0, tax = 0, total = 0;
  if (mode === "taxex"){
    sub   = roundY(sum);
    tax   = roundY(sub * rate);
    total = sub + tax;
  } else {
    total = roundY(sum);
    sub   = roundY(total / (1 + rate));
    tax   = total - sub;
  }

  return {
    company: "æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾",
    toZip:   "ã€’185-0032",
    toAddr:  "æ±äº¬éƒ½å›½åˆ†å¯ºå¸‚æ—¥å‰ç”º2-34-14 2Gå·å®¤",
    docNo, docDate, author, shop, tel, addr,
    rows, sub, tax, total, mode
  };
}

/* ===========================================================
  âœ… FIXED: Vector PDF
  - Fonts registered directly on the doc instance (not a temp doc)
  - Logo size adjusted to preserve aspect ratio
=========================================================== */
async function generatePdfVector(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"mm", format:"a4" });

  // âœ… FIX 1: Register fonts directly on this doc instance
  try {
    const regB64 = await fetchAsBase64(FONT_REG_URL);
    doc.addFileToVFS("NotoSansJP-Regular.ttf", regB64);
    doc.addFont("NotoSansJP-Regular.ttf", "NotoSansJP", "normal", "Identity-H");
  } catch(e) {
    throw new Error("Regular font load failed: " + e.message);
  }

  try {
    const boldB64 = await fetchAsBase64(FONT_BOLD_URL);
    doc.addFileToVFS("NotoSansJP-Bold.ttf", boldB64);
    doc.addFont("NotoSansJP-Bold.ttf", "NotoSansJP", "bold", "Identity-H");
  } catch(e) {
    console.warn("Bold font not available, falling back to normal:", e);
  }

  // Set Japanese font immediately after registration
  doc.setFont("NotoSansJP", "normal");

  const M = 12;
  const W = 210;

  // âœ… FIX 2: Logo with better size (preserves aspect ratio, not squished)
  let logoLoaded = false;
  try {
    const logoB64 = await fetchAsBase64(LOGO_URL);
    // Determine format from extension
    const ext = LOGO_URL.split('.').pop().toUpperCase();
    const fmt = (ext === "PNG" || ext === "png") ? "PNG" : "JPEG";
    // Create an Image to measure natural dimensions
    await new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const naturalW = img.naturalWidth;
        const naturalH = img.naturalHeight;
        // Target height: 14mm, calculate width to preserve ratio
        const targetH = 14;
        const targetW = (naturalW / naturalH) * targetH;
        doc.addImage("data:image/" + fmt.toLowerCase() + ";base64," + logoB64, fmt, M, 10, targetW, targetH);
        logoLoaded = true;
        resolve();
      };
      img.onerror = () => resolve(); // if fails, skip logo gracefully
      img.src = "data:image/" + fmt.toLowerCase() + ";base64," + logoB64;
    });
  } catch(e) {
    console.warn("Logo embed failed:", e);
  }

  // Header text â€” positioned to right of logo area
  const headerX = logoLoaded ? 50 : M;
  doc.setFont("NotoSansJP", "bold");
  doc.setFontSize(22);
  doc.text("ç´å“æ›¸", headerX, 18);

  doc.setFont("NotoSansJP", "normal");
  doc.setFontSize(12);
  doc.setTextColor(85);
  doc.text("æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾", headerX, 24);
  doc.setTextColor(17);

  const data = collectPdfData();

  // Info table
  const infoBody = [
    ["å®›å…ˆ", data.company + "\n" + data.toZip + " " + data.toAddr],
    ["ç´å“æ›¸ç•ªå·", data.docNo || "â€”"],
    ["ç´å“æ—¥",    data.docDate || "â€”"],
    ["å§“å",      data.author || "â€”"],
    ["å±‹å·",      data.shop || "â€”"],
    ["TEL",       data.tel || "â€”"],
  ];
  if (data.addr) infoBody.push(["ä½æ‰€", data.addr]);

  doc.autoTable({
    startY: 32,
    theme: "grid",
    head: [],
    body: infoBody,
    styles: {
      font: "NotoSansJP",
      fontStyle: "normal",
      fontSize: 11,
      cellPadding: 2.2,
      lineColor: 170,
      lineWidth: 0.2,
      valign: "top",
    },
    columnStyles: {
      0: { cellWidth: 36, textColor: [85,85,85], fontStyle: "bold" },
      1: { cellWidth: W - M * 2 - 36 },
    },
    margin: { left: M, right: M },
  });

  // Items table
  const startItemsY = doc.lastAutoTable.finalY + 6;

  const itemsBody = data.rows.map(r => ([
    String(r.no),
    r.name || "",
    formatNumber(r.unit),
    formatNumber(r.qty),
    formatNumber(r.amt) + " å††",
  ]));

  // Pad to at least 6 rows
  while (itemsBody.length < 6){
    itemsBody.push([String(itemsBody.length + 1), "", "", "", "0 å††"]);
  }

  const colNo   = 12;
  const colUnit = 32;
  const colQty  = 20;
  const colAmt  = 36;
  const colName = (W - M * 2) - (colNo + colUnit + colQty + colAmt);

  doc.autoTable({
    startY: startItemsY,
    theme: "grid",
    head: [["No", "å“å / ä½œå“å", "å˜ä¾¡", "æ•°é‡", "é‡‘é¡"]],
    body: itemsBody,
    styles: {
      font: "NotoSansJP",
      fontStyle: "normal",
      fontSize: 11,
      cellPadding: 2.0,
      lineColor: 170,
      lineWidth: 0.2,
      valign: "middle",
    },
    headStyles: {
      fillColor: [239, 239, 239],
      textColor: 17,
      fontStyle: "bold",
    },
    columnStyles: {
      0: { cellWidth: colNo,   halign: "center" },
      1: { cellWidth: colName, halign: "left"   },
      2: { cellWidth: colUnit, halign: "right"  },
      3: { cellWidth: colQty,  halign: "right"  },
      4: { cellWidth: colAmt,  halign: "right"  },
    },
    margin: { left: M, right: M },
  });

  const lastY = doc.lastAutoTable.finalY;

  // Sum box
  const modeLabel = data.mode === "taxex" ? "ç¨æŠœï¼ˆæ¶ˆè²»ç¨10%åˆ¥ï¼‰" : "ç¨è¾¼ï¼ˆæ¶ˆè²»ç¨10%è¾¼ï¼‰";
  const boxW = 86;
  const boxX = W - M - boxW;
  const boxY = lastY + 8;
  const lineH = 8;
  const boxH  = lineH * 4 + 8; // 4 rows now

  doc.setDrawColor(204);
  doc.roundedRect(boxX, boxY, boxW, boxH, 2, 2);

  // Divider lines
  doc.setDrawColor(224);
  doc.line(boxX, boxY + lineH + 2,       boxX + boxW, boxY + lineH + 2);
  doc.line(boxX, boxY + lineH * 2 + 4,   boxX + boxW, boxY + lineH * 2 + 4);
  doc.line(boxX, boxY + lineH * 3 + 6,   boxX + boxW, boxY + lineH * 3 + 6);

  doc.setFont("NotoSansJP", "bold");
  doc.setFontSize(10.5);

  // Row 1: mode label (muted style)
  doc.setTextColor(120);
  doc.setFontSize(9.5);
  doc.text("å˜ä¾¡å…¥åŠ›æ–¹å¼", boxX + 4, boxY + lineH - 1);
  doc.text(modeLabel, boxX + boxW - 4, boxY + lineH - 1, { align: "right" });
  doc.setTextColor(17);
  doc.setFontSize(10.5);

  const rows3 = [
    { label: "å°è¨ˆ",          value: formatNumber(data.sub)   + " å††" },
    { label: "æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰",  value: formatNumber(data.tax)   + " å††" },
    { label: "åˆè¨ˆ",          value: formatNumber(data.total) + " å††" },
  ];

  rows3.forEach((r, i) => {
    const y = boxY + lineH * (i + 1) + lineH - 1 + (i * 2);
    doc.text(r.label, boxX + 4, y);
    doc.text(r.value, boxX + boxW - 4, y, { align: "right" });
  });

  doc.save(makeName());
}

/* ===========================================================
  PDF button handler
=========================================================== */
async function handlePDF(){
  const btn  = document.getElementById("pdfBtn");
  const hint = document.getElementById("pdfHint");
  btn.disabled = true;
  hint.textContent = "PDFã‚’ä½œæˆä¸­â€¦";

  clearPH();

  try {
    await generatePdfVector();
    hint.textContent = "";
  } catch(e) {
    console.error(e);
    alert("PDFä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nã‚¨ãƒ©ãƒ¼: " + e.message + "\n\nãƒ•ã‚©ãƒ³ãƒˆãƒ»ãƒ­ã‚´ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒªãƒã‚¸ãƒˆãƒªã®ãƒ«ãƒ¼ãƒˆã«é…ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  } finally {
    restorePH();
    btn.disabled = false;
    setTimeout(() => { hint.textContent = ""; }, 4000);
  }
}
document.getElementById("pdfBtn").addEventListener("click", handlePDF);

/* ===========================================================
  Init
=========================================================== */
const d = new Date();
document.getElementById("docDate").value =
  `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
addRows(6);
</script>
</body>
</html>
