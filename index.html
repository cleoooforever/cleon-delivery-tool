<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, viewport-fit=cover" />
  <title>ç´å“æ›¸ | æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</title>

  <style>
    /* ============================================================
       CSS ARCHITECTURE:
       1. Variables & Reset
       2. Base / Screen (å…±é€š)
       3. Desktop Screen (>600px) â€” table layout
       4. Mobile Screen (â‰¤600px)  â€” card layout
       5. Print / @media print   â€” A4 table (åŒ"æ‰“å°"ç‰ˆå¼)
       6. .pdf-clone class        â€” A4 table (åŒ"æ‰“å°"ç‰ˆå¼, for html2pdf clone)
    ============================================================ */

    /* 1. Variables & Reset */
    :root {
      --bg: #f6f7f9;
      --card: #fff;
      --text: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --strong: #111;
      --accent: #0ea5a4;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { width: 100%; max-width: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        Helvetica, Arial, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-text-size-adjust: 100%;
    }

    /* 2. Base / Screen å…±é€š */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 18px 16px 64px; }

    .topbar {
      display: flex; gap: 10px; flex-wrap: wrap;
      align-items: center; justify-content: space-between;
      margin: 10px 0 16px;
    }
    .brand { display: flex; flex-direction: column; gap: 4px; }
    .brand h1 { margin: 0; font-size: 26px; letter-spacing: .5px; }
    .brand .sub { color: var(--muted); font-size: 13px; }
    .brandline { display: flex; align-items: center; gap: 14px; }
    .logo { height: 48px; width: auto; display: block; }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button {
      border: 1px solid var(--line);
      background: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }
    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    button:disabled { opacity: .6; cursor: not-allowed; }
    button:active { transform: translateY(1px); }
    .btn-mini { padding: 8px 10px; border-radius: 12px; font-weight: 700; }
    .hint { font-size: 12px; color: var(--muted); }

    /* Two-column grid layout */
    .grid {
      display: grid;
      grid-template-columns: minmax(340px, 420px) 1fr;
      gap: 14px;
      align-items: start;
    }
    @media (max-width: 980px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 8px 22px rgba(0,0,0,.04);
    }
    .title {
      display: flex; align-items: baseline; justify-content: space-between;
      gap: 12px; flex-wrap: wrap;
      border-bottom: 1px solid var(--line);
      padding-bottom: 10px; margin-bottom: 12px;
    }
    .title h2 { margin: 0; font-size: 18px; }
    .small { font-size: 12px; color: var(--muted); }

    /* åŸºæœ¬æƒ…å ± rows â€” Desktop default */
    .row {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 10px;
      align-items: center;
      margin: 8px 0;
    }
    .row label { color: var(--muted); font-size: 13px; }

    /* iOS input zoomé˜²æ­¢ï¼š16px */
    input, textarea, select {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 16px;
      background: #fff;
      min-width: 0; /* âœ… é˜²æ­¢flex/gridå†…æ’‘ç ´å®½åº¦ */
    }
    textarea { min-height: 72px; resize: vertical; }

    .dest-box {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
    }
    .dest-name { font-weight: 800; }
    .dest-addr { margin-top: 6px; color: var(--muted); font-size: 13px; line-height: 1.6; white-space: pre-line; }

    .pill {
      display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
      padding: 10px 12px;
      border: 1px dashed var(--line);
      border-radius: 14px;
      background: #fafafa;
      margin-top: 10px;
    }
    .pill b { color: var(--strong); }
    .footer-note { margin-top: 12px; color: var(--muted); font-size: 12px; line-height: 1.7; }

    /* ============================================================
       3. Desktop Table Layout (screen, >600px)
    ============================================================ */
    .table-wrap {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* âœ… KEY FIX A: table-layout:fixed + explicit col widths prevent squish */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      table-layout: fixed;
    }

    /* âœ… col widths: name gets remaining space, others locked */
    col.no     { width: 48px; }
    col.name   { width: auto; }   /* flexible â€” takes the rest */
    col.unit   { width: 130px; }
    col.qty    { width: 80px; }
    col.amount { width: 140px; }
    col.del    { width: 62px; }

    thead th {
      background: #f3f4f6;
      color: #111;
      font-weight: 700;
      font-size: 13px;
      padding: 10px 8px;
      border-bottom: 1px solid var(--line);
      white-space: nowrap;
      overflow: hidden;
    }
    tbody td {
      border-bottom: 1px solid var(--line);
      padding: 7px 8px;
      vertical-align: middle;
      font-size: 14px;
      overflow: hidden;
    }
    tbody tr:last-child td { border-bottom: none; }

    .num { text-align: right; font-variant-numeric: tabular-nums; }
    .center { text-align: center; }

    /* âœ… KEY FIX A: inputs inside td must not overflow â€” min-width:0 + width:100% */
    td input {
      width: 100%;
      min-width: 0;
      padding: 6px 8px;
      font-size: 14px;
    }
    td.unitcell input,
    td.qtycell input { text-align: right; }

    .table-actions { margin-top: 10px; display: flex; justify-content: center; }
    .table-actions button { padding: 12px 16px; border-radius: 14px; font-weight: 800; }

    .sum {
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 980px) { .sum { grid-template-columns: 1fr; } }

    .sum-box {
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
    }
    .sum-row {
      display: flex; justify-content: space-between; gap: 12px;
      padding: 8px 0; border-bottom: 1px solid var(--line);
      font-variant-numeric: tabular-nums;
    }
    .sum-row:last-child { border-bottom: none; }
    .sum-row .k { color: #111; font-weight: 700; }
    .sum-row .v { font-weight: 800; }

    /* ============================================================
       4. Mobile Screen (â‰¤600px) â€” Card layout + fixed .row
    ============================================================ */
    @media (max-width: 600px) {

      /* âœ… KEY FIX B: æ‰‹æœºç«¯åŸºæœ¬ä¿¡æ¯æ”¹ä¸ºä¸Šä¸‹å¸ƒå±€ï¼Œé˜²æ­¢ date input æ¯”ä¾‹å¤±è¡¡ */
      .row {
        grid-template-columns: 1fr;
        gap: 4px;
        align-items: stretch;
        margin: 10px 0;
      }
      .row label {
        font-size: 12px;
        font-weight: 600;
        color: var(--muted);
      }

      /* Card layout for table rows */
      .table-wrap {
        overflow: visible;
        border: 0;
        background: transparent;
      }
      table { min-width: 0; background: transparent; }
      table, thead, tbody, tr, td { display: block; width: 100%; }
      thead { display: none; }

      tbody tr {
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 12px;
        margin: 10px 0;
        box-shadow: 0 8px 22px rgba(0,0,0,.04);
      }
      tbody td {
        border-bottom: 0;
        padding: 6px 0;
        overflow: visible;
      }

      /* No column */
      tbody td:nth-child(1) {
        padding-top: 0;
        font-weight: 800;
        color: #111;
        display: flex;
        justify-content: center;
      }
      /* å“å */
      tbody td:nth-child(2) { display: block; }
      tbody td:nth-child(2)::before {
        content: "å“å / ä½œå“å";
        display: block;
        color: var(--muted);
        font-weight: 700;
        font-size: 12px;
        margin-bottom: 6px;
      }
      tbody td:nth-child(2) input { width: 100%; }

      /* å˜ä¾¡ãƒ»æ•°é‡ãƒ»é‡‘é¡ãƒ»å‰Šé™¤ */
      tbody td:nth-child(3),
      tbody td:nth-child(4),
      tbody td:nth-child(5),
      tbody td:nth-child(6) {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      tbody td:nth-child(3)::before { content: "å˜ä¾¡";   color: var(--muted); font-weight: 700; font-size: 12px; flex: 0 0 auto; }
      tbody td:nth-child(4)::before { content: "æ•°é‡";   color: var(--muted); font-weight: 700; font-size: 12px; flex: 0 0 auto; }
      tbody td:nth-child(5)::before { content: "é‡‘é¡";   color: var(--muted); font-weight: 700; font-size: 12px; flex: 0 0 auto; }
      tbody td:nth-child(6)::before { content: "å‰Šé™¤";   color: var(--muted); font-weight: 700; font-size: 12px; flex: 0 0 auto; }

      tbody td:nth-child(3) input,
      tbody td:nth-child(4) input { width: 58%; text-align: right; }

      tbody td:nth-child(5) {
        padding-top: 10px;
        border-top: 1px dashed var(--line);
        margin-top: 6px;
      }
      .amount { font-weight: 900; }
      tbody td:nth-child(6) button { padding: 10px 14px; border-radius: 14px; font-weight: 900; }
    }

    /* ============================================================
       5. @media print â€” A4 è¡¨æ ¼ç‰ˆå¼ï¼ˆç³»ç»Ÿæ‰“å°ï¼‰
    ============================================================ */
    @page { size: A4; margin: 12mm; }
    @media print {
      body { background: #fff; }
      .wrap { max-width: none; padding: 0; }
      .actions, .pill, .table-actions, .footer-note { display: none !important; }
      .card { box-shadow: none; border: 0; border-radius: 0; padding: 0; }
      .grid { grid-template-columns: 1fr !important; gap: 0 !important; }

      /* âœ… Force table layout in print */
      .table-wrap {
        border: 1px solid #999;
        border-radius: 0;
        overflow: visible !important;
        background: #fff !important;
      }
      table {
        display: table !important;
        width: 100% !important;
        border-collapse: collapse !important;
        table-layout: fixed !important;
        min-width: 0 !important;
        background: #fff !important;
      }
      col.no     { width: 40px !important; }
      col.unit   { width: 120px !important; }
      col.qty    { width: 70px !important; }
      col.amount { width: 130px !important; }
      col.del    { display: none !important; }

      thead  { display: table-header-group !important; }
      tbody  { display: table-row-group !important; }
      tr     { display: table-row !important; page-break-inside: avoid !important; }
      th, td { display: table-cell !important; }
      td::before { content: none !important; }

      tbody tr {
        box-shadow: none !important;
        border: 0 !important;
        border-radius: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
        background: #fff !important;
      }
      thead th {
        background: #eee !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      tbody td {
        border: 1px solid #999 !important;
        padding: 7px 8px !important;
        overflow: hidden !important;
        vertical-align: middle !important;
      }
      /* éšè—åˆ é™¤åˆ— */
      th:last-child, td:last-child { display: none !important; }

      input, textarea, select {
        border: 0 !important;
        padding: 0 !important;
        font-size: 12px !important;
        background: transparent !important;
        -webkit-appearance: none;
        appearance: none;
      }

      /* åŸºæœ¬æƒ…å ± rows: æ‰“å°æ—¶ä¹Ÿç”¨2åˆ— */
      .row {
        grid-template-columns: 140px 1fr !important;
        gap: 8px !important;
        align-items: center !important;
        margin: 6px 0 !important;
      }
      .sum { grid-template-columns: 1fr !important; }
      .sum-box {
        width: 280px;
        margin-left: auto;
      }
    }

    /* ============================================================
       6. .pdf-clone â€” PDFä¸‹è½½ç”¨çš„å…‹éš†å®¹å™¨
          å®Œå…¨é•œåƒ @media print çš„æ ·å¼ï¼Œä½†ä½œä¸ºæ™®é€šclassï¼ˆhtml2pdfä½¿ç”¨screen CSSï¼‰
    ============================================================ */
    .pdf-clone {
      background: #fff;
      width: 794px;  /* A4 @ 96dpi */
      padding: 34px 45px;
      font-family: system-ui, -apple-system, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      color: #111;
      font-size: 13px;
    }
    .pdf-clone .actions,
    .pdf-clone .pill,
    .pdf-clone .table-actions,
    .pdf-clone .footer-note,
    .pdf-clone .hint,
    .pdf-clone .sub { display: none !important; }

    .pdf-clone .wrap { max-width: none; padding: 0; }
    .pdf-clone .topbar { margin-bottom: 20px; }
    .pdf-clone .grid { display: block; }
    .pdf-clone .card { box-shadow: none; border: 0; border-radius: 0; padding: 0; margin-bottom: 18px; }
    .pdf-clone .title { border-bottom: 2px solid #111; padding-bottom: 6px; margin-bottom: 10px; }
    .pdf-clone .title h2 { font-size: 15px; }

    /* åŸºæœ¬æƒ…å ± rows â€” 2åˆ— */
    .pdf-clone .row {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px;
      align-items: center;
      margin: 5px 0;
    }
    .pdf-clone .row label { color: #555; font-size: 12px; }
    .pdf-clone .dest-box { border: 1px solid #ccc; border-radius: 6px; padding: 6px 10px; background: #fff; }
    .pdf-clone .dest-name { font-weight: 800; font-size: 13px; }
    .pdf-clone .dest-addr { font-size: 11px; color: #555; margin-top: 4px; white-space: pre-line; line-height: 1.5; }

    /* inputs in pdf-clone: show as plain text */
    .pdf-clone input,
    .pdf-clone textarea,
    .pdf-clone select {
      border: 0 !important;
      background: transparent !important;
      padding: 0 !important;
      font-size: 12px !important;
      width: 100% !important;
      min-width: 0 !important;
      -webkit-appearance: none;
      appearance: none;
      resize: none;
    }
    .pdf-clone textarea { min-height: auto; overflow: hidden; }

    /* table */
    .pdf-clone .table-wrap {
      border: 1px solid #999;
      border-radius: 0;
      overflow: visible;
      background: #fff;
    }
    .pdf-clone table {
      display: table !important;
      width: 100% !important;
      border-collapse: collapse !important;
      table-layout: fixed !important;
      min-width: 0 !important;
      background: #fff !important;
    }
    .pdf-clone col.no     { width: 38px; }
    .pdf-clone col.name   { width: auto; }
    .pdf-clone col.unit   { width: 110px; }
    .pdf-clone col.qty    { width: 65px; }
    .pdf-clone col.amount { width: 120px; }
    .pdf-clone col.del    { display: none; width: 0; }

    .pdf-clone thead  { display: table-header-group !important; }
    .pdf-clone tbody  { display: table-row-group !important; }
    .pdf-clone tr     { display: table-row !important; }
    .pdf-clone th,
    .pdf-clone td     { display: table-cell !important; }
    .pdf-clone td::before { content: none !important; }

    .pdf-clone thead th {
      background: #eeeeee !important;
      font-weight: 700;
      font-size: 12px;
      padding: 7px 6px;
      border: 1px solid #999;
      white-space: nowrap;
    }
    .pdf-clone tbody tr {
      box-shadow: none !important;
      border: 0 !important;
      border-radius: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      background: #fff !important;
    }
    .pdf-clone tbody td {
      border: 1px solid #999 !important;
      padding: 6px 6px !important;
      overflow: hidden !important;
      vertical-align: middle !important;
      font-size: 12px !important;
    }
    /* éšè—åˆ é™¤åˆ— */
    .pdf-clone th:last-child,
    .pdf-clone td:last-child { display: none !important; }

    .pdf-clone .num { text-align: right; font-variant-numeric: tabular-nums; }
    .pdf-clone .center { text-align: center; }

    /* sum box */
    .pdf-clone .sum { display: block; margin-top: 10px; }
    .pdf-clone .sum-box {
      width: 260px;
      margin-left: auto;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 8px 10px;
    }
    .pdf-clone .sum-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #e5e7eb;
      font-size: 12px;
    }
    .pdf-clone .sum-row:last-child { border-bottom: none; }
    .pdf-clone .sum-row .k { font-weight: 700; }
    .pdf-clone .sum-row .v { font-weight: 800; }

    /* brand/logo in pdf */
    .pdf-clone .brand h1 { font-size: 20px; margin: 0; }
    .pdf-clone .logo { height: 36px; }
  </style>

  <!-- PDFç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="brandline">
          <img src="cleon-logo.PNG" alt="ClÃ©on arts & trade" class="logo" />
          <div>
            <h1>ç´å“æ›¸</h1>
            <div class="sub"><b>æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</b>ã€€ï½œã€€PDFã¯å³ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã§ãã¾ã™ã€‚</div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-mini" id="clearBtn">å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        <button type="button" class="primary btn-mini" id="pdfBtn">ğŸ“„ PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button type="button" class="btn-mini" id="printBtn">ğŸ–¨ å°åˆ·</button>
        <span class="hint" id="pdfHint"></span>
      </div>
    </div>

    <div id="pdfRoot">
      <div class="grid">

        <!-- LEFT: åŸºæœ¬æƒ…å ± -->
        <div class="card">
          <div class="title">
            <h2>åŸºæœ¬æƒ…å ±</h2>
            <div class="small">ä½œè€…ã•ã¾ãŒå…¥åŠ› â†’ PDFä¿å­˜ â†’ ãƒ¡ãƒ¼ãƒ«/LINEç­‰ã§é€ä»˜</div>
          </div>

          <div class="row">
            <label>å®›å…ˆ</label>
            <div class="dest-box">
              <div class="dest-name">æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</div>
              <div class="dest-addr">ã€’185-0032
æ±äº¬éƒ½å›½åˆ†å¯ºå¸‚æ—¥å‰ç”º2-34-14 2Gå·å®¤</div>
            </div>
          </div>

          <div class="row">
            <label>ç´å“æ›¸ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
            <input id="docNo" placeholder="ä¾‹ï¼š2026-001" data-ph="ä¾‹ï¼š2026-001" />
          </div>

          <div class="row">
            <label>ç´å“æ—¥</label>
            <input id="docDate" type="date" />
          </div>

          <div class="row">
            <label>å§“å</label>
            <input id="authorName" placeholder="ä¾‹ï¼šæ¾„å’Œ èŠ±å­" data-ph="ä¾‹ï¼šæ¾„å’Œ èŠ±å­" />
          </div>

          <div class="row">
            <label>å±‹å·</label>
            <input id="shopName" placeholder="ä¾‹ï¼šatelier â—‹â—‹" data-ph="ä¾‹ï¼šatelier â—‹â—‹" />
          </div>

          <div class="row">
            <label>TEL</label>
            <input id="tel" placeholder="ä¾‹ï¼š090-xxxx-xxxx" data-ph="ä¾‹ï¼š090-xxxx-xxxx" />
          </div>

          <div class="row">
            <label>ä½æ‰€ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="addr" placeholder="ä¾‹ï¼šã€’xxx-xxxx æ±äº¬éƒ½â€¦" data-ph="ä¾‹ï¼šã€’xxx-xxxx æ±äº¬éƒ½â€¦"></textarea>
          </div>

          <div class="pill">
            <span>å…¥åŠ›æ–¹å¼ï¼š</span>
            <select id="mode">
              <option value="taxin" selected>ãŠã™ã™ã‚ï¼šç¨è¾¼ï¼ˆæ¶ˆè²»ç¨10%è¾¼ï¼‰ã§å…¥åŠ›</option>
              <option value="taxex">ç¨æŠœï¼ˆæ¶ˆè²»ç¨ã‚’åˆ¥è¨ˆç®—ï¼‰ã§å…¥åŠ›</option>
            </select>
            <span class="small">ç¨ç‡ï¼š<b>10%</b>ï¼ˆå›ºå®šï¼‰ï½œç«¯æ•°ï¼š<b>å››æ¨äº”å…¥</b></span>
          </div>

          <div class="footer-note">
            â€»ã€Œç¨è¾¼ï¼ˆ10%è¾¼ï¼‰ã€ã‚’é¸ã¶ã¨ã€ä½œè€…ã•ã¾ã¯<b>ç¨è¾¼å˜ä¾¡</b>ã ã‘å…¥åŠ›ã™ã‚Œã°OKã§ã™ã€‚<br/>
            å½“ã‚µã‚¤ãƒˆã¯ClÃ©onå°‚ç”¨ã®å†…éƒ¨ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚å…¥åŠ›æƒ…å ±ã¯å¤–éƒ¨ã¸æµå‡ºã—ã¾ã›ã‚“ã€‚
          </div>
        </div>

        <!-- RIGHT: æ˜ç´° -->
        <div class="card">
          <div class="title">
            <h2>æ˜ç´°</h2>
            <div class="small">å˜ä¾¡ Ã— æ•°é‡ â†’ é‡‘é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</div>
          </div>

          <div class="table-wrap">
            <table id="itemsTable">
              <colgroup>
                <col class="no">
                <col class="name">
                <col class="unit">
                <col class="qty">
                <col class="amount">
                <col class="del">
              </colgroup>
              <thead>
                <tr>
                  <th class="center">No</th>
                  <th>å“å / ä½œå“å</th>
                  <th class="num">å˜ä¾¡</th>
                  <th class="num">æ•°é‡</th>
                  <th class="num">é‡‘é¡</th>
                  <th class="center">å‰Šé™¤</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>

          <div class="table-actions">
            <button type="button" class="btn-mini" id="addRowBtn">ï¼‹ è¡Œã‚’è¿½åŠ </button>
          </div>

          <div class="sum">
            <div class="footer-note">
              â€» é‡‘é¡ã¯è‡ªå‹•è¨ˆç®—ã§ã™ã€‚ã€ŒPDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§PDFãŒä½œæˆã§ãã¾ã™ã€‚<br/>
              â€» ç¨è¾¼å…¥åŠ›æ™‚ï¼š<b>åˆè¨ˆï¼ˆç¨è¾¼ï¼‰</b>ã¯å…¥åŠ›é‡‘é¡ã®åˆç®—ã€ãã®å†…è¨³ã¨ã—ã¦<b>å°è¨ˆï¼ˆç¨æŠœï¼‰</b>ã¨<b>æ¶ˆè²»ç¨</b>ã‚’ç®—å‡ºã—ã¾ã™ã€‚
            </div>
            <div class="sum-box">
              <div class="sum-row"><div class="k">å°è¨ˆ</div><div class="v" id="subTotal">0 å††</div></div>
              <div class="sum-row"><div class="k">æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰</div><div class="v" id="tax">0 å††</div></div>
              <div class="sum-row"><div class="k">åˆè¨ˆ</div><div class="v" id="grandTotal">0 å††</div></div>
            </div>
          </div>
        </div>

      </div>
    </div><!-- /pdfRoot -->
  </div><!-- /wrap -->

<script>
  /* ============================================================
     Helpers
  ============================================================ */
  const yen = n => (Number.isFinite(n) ? n : 0).toLocaleString("ja-JP") + " å††";
  const toInt = v => {
    const s = String(v ?? "").replace(/[^\d.-]/g, "");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const roundYen = n => Math.round(n);

  /* Placeholder clear/restore for PDF & print */
  const _phBackup = new Map();
  function clearPlaceholders() {
    document.querySelectorAll("[data-ph], input.name, input.unit, input.qty").forEach(el => {
      _phBackup.set(el, el.getAttribute("placeholder") || "");
      el.setAttribute("placeholder", "");
    });
  }
  function restorePlaceholders() {
    _phBackup.forEach((val, el) => {
      try { el.setAttribute("placeholder", val); } catch(e) {}
    });
    _phBackup.clear();
  }

  /* ============================================================
     DOM refs
  ============================================================ */
  const tbody      = document.getElementById("tbody");
  const addRowBtn  = document.getElementById("addRowBtn");
  const clearBtn   = document.getElementById("clearBtn");
  const printBtn   = document.getElementById("printBtn");
  const pdfBtn     = document.getElementById("pdfBtn");
  const pdfHint    = document.getElementById("pdfHint");
  const modeSel    = document.getElementById("mode");
  const subTotalEl = document.getElementById("subTotal");
  const taxEl      = document.getElementById("tax");
  const grandTotalEl = document.getElementById("grandTotal");

  /* ============================================================
     Row management
  ============================================================ */
  function makeRow(i) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="center no">${i}</td>
      <td class="namecell"><input class="name" placeholder="ä¾‹ï¼šã‚«ãƒƒãƒ—ã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­ / ãƒ–ãƒ­ãƒ¼ãƒ ãªã©" /></td>
      <td class="num unitcell"><input class="unit" inputmode="numeric" placeholder="0" /></td>
      <td class="num qtycell"><input class="qty" inputmode="numeric" placeholder="1" value="1" /></td>
      <td class="num amount">0 å††</td>
      <td class="center"><button type="button" class="btn-mini del">Ã—</button></td>
    `;
    tr.querySelector(".del").addEventListener("click", () => {
      tr.remove(); renumber(); recalc();
    });
    tr.querySelectorAll("input").forEach(inp => inp.addEventListener("input", recalc));
    return tr;
  }

  function renumber() {
    [...tbody.querySelectorAll("tr")].forEach((tr, idx) => {
      tr.querySelector(".no").textContent = String(idx + 1);
    });
  }

  function addRows(n) {
    const start = tbody.querySelectorAll("tr").length;
    for (let k = 0; k < n; k++) tbody.appendChild(makeRow(start + k + 1));
    recalc();
  }

  function recalc() {
    let sumLine = 0;
    [...tbody.querySelectorAll("tr")].forEach(tr => {
      const unit = toInt(tr.querySelector(".unit").value);
      const qty  = Math.max(0, toInt(tr.querySelector(".qty").value || 0));
      const amt  = roundYen(unit * qty);
      tr.querySelector(".amount").textContent = yen(amt);
      sumLine += amt;
    });

    const mode = modeSel.value;
    const taxRate = 0.10;

    if (mode === "taxex") {
      const sub   = roundYen(sumLine);
      const tax   = roundYen(sub * taxRate);
      const total = sub + tax;
      subTotalEl.textContent   = yen(sub);
      taxEl.textContent        = yen(tax);
      grandTotalEl.textContent = yen(total);
    } else {
      const total = roundYen(sumLine);
      const sub   = roundYen(total / (1 + taxRate));
      const tax   = total - sub;
      subTotalEl.textContent   = yen(sub);
      taxEl.textContent        = yen(tax);
      grandTotalEl.textContent = yen(total);
    }
  }

  addRowBtn.addEventListener("click", () => addRows(1));
  modeSel.addEventListener("change", recalc);

  /* ============================================================
     Clear
  ============================================================ */
  clearBtn.addEventListener("click", () => {
    if (!confirm("å…¥åŠ›å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    ["docNo","authorName","shopName","tel","addr"].forEach(id => {
      document.getElementById(id).value = "";
    });
    const d = new Date();
    document.getElementById("docDate").value =
      `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    modeSel.value = "taxin";
    tbody.innerHTML = "";
    addRows(6);
  });

  /* ============================================================
     Print
  ============================================================ */
  printBtn.addEventListener("click", () => {
    clearPlaceholders();
    window.print();
    setTimeout(restorePlaceholders, 1500);
  });

  /* ============================================================
     Device detection
  ============================================================ */
  function isAndroid() {
    return /android/i.test(navigator.userAgent);
  }
  function isIOS() {
    return /iP(hone|ad|od)/i.test(navigator.userAgent);
  }
  function isMobile() {
    return isAndroid() || isIOS();
  }

  /* ============================================================
     PDF filename
  ============================================================ */
  function makePDFFilename() {
    const docNo  = (document.getElementById("docNo").value || "").trim();
    const author = (document.getElementById("authorName").value || "").trim();
    const d      = (document.getElementById("docDate").value || "").trim();
    const base   = docNo ? `ç´å“æ›¸_${docNo}` : "ç´å“æ›¸";
    const tail   = [author, d].filter(Boolean).join("_");
    return (tail ? `${base}_${tail}` : base) + ".pdf";
  }

  /* ============================================================
     Build PDF clone DOM
     âœ… KEY FIX C: Clone pdfRoot + apply .pdf-clone CSS class
       (completely independent from mobile screen CSS)
  ============================================================ */
  function buildPDFClone() {
    const src   = document.getElementById("pdfRoot");
    const clone = src.cloneNode(true);

    // Remove delete buttons (not needed in PDF)
    clone.querySelectorAll(".del, .table-actions").forEach(el => el.remove());

    // Wrap with pdf-clone class
    const wrapper = document.createElement("div");
    wrapper.className = "pdf-clone";
    wrapper.appendChild(clone);

    // Host element (off-screen)
    const host = document.createElement("div");
    host.style.cssText = "position:fixed;left:-99999px;top:0;background:#fff;z-index:-1;";
    host.appendChild(wrapper);
    return { host, wrapper };
  }

  /* ============================================================
     Download PDF (Chrome/Edge/Firefox/Safari desktop)
     Fallback: window.print() for Android & unstable browsers
  ============================================================ */
  async function downloadPDF() {
    // âœ… KEY FIX D: Android fallback â€” use print dialog
    if (isAndroid()) {
      showAndroidPrintDialog();
      return;
    }

    if (!window.html2pdf) {
      alert("PDFç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã€Œå°åˆ·ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å°åˆ· â†’ PDFã«ä¿å­˜ ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚");
      return;
    }

    pdfBtn.disabled = true;
    pdfHint.textContent = "PDFã‚’ä½œæˆä¸­â€¦";
    clearPlaceholders();

    const { host, wrapper } = buildPDFClone();
    document.body.appendChild(host);

    try {
      await html2pdf()
        .set({
          margin: [0, 0, 0, 0],
          filename: makePDFFilename(),
          image: { type: "jpeg", quality: 0.97 },
          html2canvas: {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff",
            scrollY: 0,
            windowWidth: 794,
            width: 794,
          },
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
          pagebreak: { mode: ["css", "legacy"] }
        })
        .from(wrapper)
        .save();
    } catch(e) {
      console.error("html2pdf error:", e);
      // Fallback to print
      const doFallback = confirm(
        "PDFã®è‡ªå‹•ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n" +
        "ã€Œå°åˆ·ã€ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã„ã¦ã€ŒPDFã«ä¿å­˜ã€ã™ã‚‹æ–¹æ³•ã§ã‚‚PDFã‚’ä½œæˆã§ãã¾ã™ã€‚\n\n" +
        "ä»Šã™ãå°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã¾ã™ã‹ï¼Ÿ"
      );
      if (doFallback) {
        clearPlaceholders();
        window.print();
        setTimeout(restorePlaceholders, 1500);
      }
    } finally {
      document.body.removeChild(host);
      restorePlaceholders();
      pdfBtn.disabled = false;
      pdfHint.textContent = "";
    }
  }

  /* ============================================================
     Android fallback: open a print-ready window
     âœ… KEY FIX D: A4è¡¨æ ¼ç‰ˆå¼ in new window â†’ user taps "Save as PDF"
  ============================================================ */
  function showAndroidPrintDialog() {
    // Collect current input values
    const docNo     = document.getElementById("docNo").value;
    const docDate   = document.getElementById("docDate").value;
    const authorName = document.getElementById("authorName").value;
    const shopName  = document.getElementById("shopName").value;
    const tel       = document.getElementById("tel").value;
    const addr      = document.getElementById("addr").value;
    const mode      = modeSel.value;

    // Collect rows
    const rows = [...tbody.querySelectorAll("tr")].map(tr => ({
      no:   tr.querySelector(".no").textContent,
      name: tr.querySelector(".name").value,
      unit: tr.querySelector(".unit").value,
      qty:  tr.querySelector(".qty").value,
      amt:  tr.querySelector(".amount").textContent,
    }));

    const subTotal   = subTotalEl.textContent;
    const tax        = taxEl.textContent;
    const grandTotal = grandTotalEl.textContent;

    const rowsHTML = rows.map(r => `
      <tr>
        <td style="text-align:center">${r.no}</td>
        <td>${escHtml(r.name)}</td>
        <td style="text-align:right">${escHtml(r.unit)}</td>
        <td style="text-align:right">${escHtml(r.qty)}</td>
        <td style="text-align:right">${r.amt}</td>
      </tr>`).join("");

    const printWin = window.open("", "_blank");
    if (!printWin) {
      alert("ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¨±å¯è¨­å®šã‚’ã”ç¢ºèªã®ä¸Šã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
      return;
    }

    printWin.document.write(`<!doctype html>
<html lang="ja"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ç´å“æ›¸</title>
<style>
  @page{size:A4;margin:12mm}
  *{box-sizing:border-box}
  body{margin:0;padding:20px;font-family:"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",system-ui,sans-serif;font-size:13px;color:#111;background:#fff}
  h1{font-size:22px;margin:0 0 4px}
  .sub{font-size:12px;color:#555;margin-bottom:18px}
  .info-grid{display:grid;grid-template-columns:130px 1fr;gap:6px 10px;margin-bottom:18px;font-size:13px}
  .info-grid .label{color:#555;font-weight:700}
  .dest-box{border:1px solid #ccc;border-radius:4px;padding:6px 10px}
  table{width:100%;border-collapse:collapse;table-layout:fixed;margin-bottom:14px}
  col.no{width:36px}col.unit{width:110px}col.qty{width:65px}col.amount{width:120px}
  th{background:#eee;font-size:12px;padding:7px 6px;border:1px solid #999;white-space:nowrap}
  td{border:1px solid #999;padding:6px 6px;font-size:12px;vertical-align:middle}
  .right{text-align:right}.center{text-align:center}
  .sum-box{width:260px;margin-left:auto;border:1px solid #ccc;border-radius:4px;padding:8px 10px}
  .sum-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #e5e7eb;font-size:12px}
  .sum-row:last-child{border-bottom:none}
  .sum-row .k{font-weight:700}.sum-row .v{font-weight:800}
  .print-btn{display:block;margin:20px auto 0;padding:14px 32px;background:#0ea5a4;color:#fff;border:0;border-radius:10px;font-size:16px;font-weight:700;cursor:pointer}
  @media print{.print-btn{display:none}}
</style>
</head><body>
<h1>ç´å“æ›¸</h1>
<div class="sub">æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</div>
<div class="info-grid">
  <div class="label">å®›å…ˆ</div>
  <div class="dest-box"><b>æ¾„å’Œå‰µè—åˆåŒä¼šç¤¾</b><br/><span style="font-size:11px;color:#555">ã€’185-0032 æ±äº¬éƒ½å›½åˆ†å¯ºå¸‚æ—¥å‰ç”º2-34-14 2Gå·å®¤</span></div>
  <div class="label">ç´å“æ›¸ç•ªå·</div><div>${escHtml(docNo) || "â€”"}</div>
  <div class="label">ç´å“æ—¥</div><div>${escHtml(docDate) || "â€”"}</div>
  <div class="label">å§“å</div><div>${escHtml(authorName) || "â€”"}</div>
  <div class="label">å±‹å·</div><div>${escHtml(shopName) || "â€”"}</div>
  <div class="label">TEL</div><div>${escHtml(tel) || "â€”"}</div>
  ${addr ? `<div class="label">ä½æ‰€</div><div>${escHtml(addr)}</div>` : ""}
</div>
<table>
  <colgroup>
    <col class="no"><col><col class="unit"><col class="qty"><col class="amount">
  </colgroup>
  <thead><tr>
    <th class="center">No</th>
    <th>å“å / ä½œå“å</th>
    <th class="right">å˜ä¾¡</th>
    <th class="right">æ•°é‡</th>
    <th class="right">é‡‘é¡</th>
  </tr></thead>
  <tbody>${rowsHTML}</tbody>
</table>
<div class="sum-box">
  <div class="sum-row"><div class="k">å°è¨ˆ</div><div class="v">${subTotal}</div></div>
  <div class="sum-row"><div class="k">æ¶ˆè²»ç¨ï¼ˆ10%ï¼‰</div><div class="v">${tax}</div></div>
  <div class="sum-row"><div class="k">åˆè¨ˆ</div><div class="v">${grandTotal}</div></div>
</div>
<button class="print-btn" onclick="window.print()">ğŸ–¨ å°åˆ· / PDFã«ä¿å­˜</button>
</body></html>`);
    printWin.document.close();
  }

  function escHtml(str) {
    return String(str || "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/\n/g,"<br/>");
  }

  pdfBtn.addEventListener("click", downloadPDF);

  /* ============================================================
     Init
  ============================================================ */
  const now = new Date();
  document.getElementById("docDate").value =
    `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;

  addRows(6);
</script>
</body>
</html>
